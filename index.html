<!doctypehtml><html lang=en><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=manifest href=manifest.webmanifest><meta name=theme-color content=#7c5cff><link rel=apple-touch-icon href=assets/logo.png><meta name=apple-mobile-web-app-capable content=yes><title>AniMehList — Your Anime Shelf</title><link rel=icon href=assets/logo.png type=image/png><link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@400;600;700&family=Lato:wght@400;700;900&display=swap"rel=stylesheet><link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css rel=stylesheet><style>:root{--bg:#0b0c10;--panel:#0f1117;--panel-2:#0b0f16;--text:#e6e8ef;--muted:#9aa3b2;--brand:#7c3aed;--brand-2:#22d3ee;--ok:#22c55e;--warn:#f59e0b;--danger:#f56565;--card:#151927;--chip:#1d2336;--ring:#2b2f45;--radius:14px;--radius-sm:10px;--container:1100px;--title-font:"Orbitron",system-ui,-apple-system,"Segoe UI",Roboto;--body-font:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Arial;--chat-font:"Lato",system-ui,-apple-system,Segoe UI,Roboto,Arial;--ui-duration:220ms;--bp-mobile:720px;--bp-compact:520px;--bp-small:600px;--accent-1:#6ee7ff;--accent-2:#a78bfa;--accent-3:#22d3ee;--susie:#9f1239;--stroke:rgba(255, 255, 255, 0.1);--z-header:60;--z-panel:80;--z-scrolltop:90;--z-modal:300;--z-chat:330;--z-auth:340;--z-confirm:350;--z-toast:380;--z-cover-progress:385;--z-loading:390;--z-preloader:500;--z-offline:600;--c-white:#ffffff;--c-black:#000000;--bg-grad-top:#07070a;--surface-0:#101525;--surface-1:#12182a;--surface-2:#131826;--surface-3:#0f1424;--surface-4:#141a2a;--surface-5:#11162a;--surface-6:#0e1323;--surface-7:#1a2040;--surface-8:#11162e;--surface-9:#1a2240;--surface-10:#1f2850;--surface-11:#131a2f;--surface-12:#151a2b;--surface-13:#171f38;--surface-14:#1c2240;--surface-15:#10162a;--surface-16:#0a0d17;--surface-danger:#2d1a25;--toast-info:#1b304a;--text-0:#e9ecf3;--text-1:#e8ecfa;--text-2:#cbd5f7;--text-3:#c6cde0;--text-4:#cfe0ff;--text-5:#d4daf0;--text-6:#d6dbef;--text-7:#b6bfd3;--text-8:#b3bad2;--text-9:#aeb8d9;--text-10:#dfe6ff;--text-11:#eaf0ff;--text-muted-1:#cbd3ea;--text-muted-2:#aab3cf;--text-muted-3:#98a2c0;--text-muted-4:#cfd6ea;--text-link:#8ab4ff;--green-600:#16a34a;--danger-2:#ef6b6b;--danger-soft-text:#fee2e2;--green-soft:#86efac;--gray-700:#374151;--page-accent-dark:#061220;--a-white-0:rgba(255, 255, 255, 0);--a-white-02:rgba(255, 255, 255, 0.02);--a-white-03:rgba(255, 255, 255, 0.03);--a-white-04:rgba(255, 255, 255, 0.04);--a-white-06:rgba(255, 255, 255, 0.06);--a-white-08:rgba(255, 255, 255, 0.08);--a-white-10:rgba(255, 255, 255, 0.1);--a-white-12:rgba(255, 255, 255, 0.12);--a-white-14:rgba(255, 255, 255, 0.14);--a-white-15:rgba(255, 255, 255, 0.15);--a-white-18:rgba(255, 255, 255, 0.18);--a-white-20:rgba(255, 255, 255, 0.2);--a-white-22:rgba(255, 255, 255, 0.22);--a-white-25:rgba(255, 255, 255, 0.25);--a-black-0:rgba(0, 0, 0, 0);--a-black-25:rgba(0, 0, 0, 0.25);--a-black-35:rgba(0, 0, 0, 0.35);--a-black-45:rgba(0, 0, 0, 0.45);--a-black-50:rgba(0, 0, 0, 0.5);--a-black-55:rgba(0, 0, 0, 0.55);--a-black-62:rgba(0, 0, 0, 0.62);--a-black-65:rgba(0, 0, 0, 0.65);--a-black-70:rgba(0, 0, 0, 0.7);--a-black-75:rgba(0, 0, 0, 0.75);--a-black-86:rgba(0, 0, 0, 0.86);--header-glass:rgba(11, 12, 16, 0.9);--hero-glass:rgba(7, 8, 12, 0.45);--banner-ov-1:rgba(7, 8, 12, 0.6);--banner-ov-2:rgba(7, 8, 12, 0.75);--banner-ov-3:rgba(7, 8, 12, 0.9);--modal-overlay:rgba(5, 7, 12, 0.72);--modal-overlay-strong:rgba(5, 7, 12, 0.86);--ink-70:rgba(6, 9, 16, 0.7);--ink-90:rgba(6, 9, 16, 0.9);--deep-shadow:rgba(1, 5, 18, 0.5);--cover-progress-bg:rgba(16, 22, 42, 0.92);--focus-ring-color:rgba(124, 58, 237, 0.14);--focus-ring:0 0 0 4px var(--focus-ring-color);--shadow:0 10px 24px var(--a-black-35);--select-arrow:var(--text-4);--scrollbar-thumb-start:#3b82f6;--chip-bg:#161c2e;--stat-value-default:#e9f0ff;--text-empty:#bbb;--brand-a10:rgba(124, 58, 237, 0.1);--brand-a18:rgba(124, 58, 237, 0.18);--brand-a22:rgba(124, 58, 237, 0.22);--brand-a25:rgba(124, 58, 237, 0.25);--brand-a70:rgba(124, 58, 237, 0.7);--brand-a75:rgba(124, 58, 237, 0.75);--brand-2-a12:rgba(34, 211, 238, 0.12);--brand-2-a15:rgba(34, 211, 238, 0.15);--brand-2-a20:rgba(34, 211, 238, 0.2);--brand-2-a45:rgba(34, 211, 238, 0.45);--brand-2-a70:rgba(34, 211, 238, 0.7);--brand-2-a75:rgba(34, 211, 238, 0.75);--accent-2-a18:rgba(167, 139, 250, 0.18);--accent-2-a35:rgba(167, 139, 250, 0.35);--accent-2-a85:rgba(167, 139, 250, 0.85);--preloader-overlay:rgba(7, 8, 12, 0.92);--susie-a30:rgba(159, 18, 57, 0.3);--susie-a40:rgba(159, 18, 57, 0.4);--susie-a60:rgba(159, 18, 57, 0.6);--warn-a18:rgba(245, 158, 11, 0.18);--warn-a28:rgba(245, 158, 11, 0.28);--warn-a55:rgba(245, 158, 11, 0.55);--offline-grad-1:rgba(255, 165, 0, 0.3);--offline-grad-2:rgba(255, 149, 0, 0.2);--offline-grad-3:rgba(255, 140, 0, 0.15);--offline-grad-4:rgba(255, 130, 0, 0.2)}*{box-sizing:border-box}img{max-width:100%}*{scrollbar-color:var(--gray-700) var(--panel-2);scrollbar-width:thin}::-webkit-scrollbar{width:10px;height:10px}::-webkit-scrollbar-track{background:var(--panel-2)}::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--scrollbar-thumb-start),var(--accent-2));border-radius:10px;border:2px solid var(--panel-2)}::-webkit-scrollbar-thumb:hover{background:linear-gradient(180deg,var(--brand-2),var(--brand))}body,html{height:100%;overflow-x:hidden}html{scroll-behavior:smooth}body{margin:0;background:linear-gradient(180deg,var(--bg-grad-top),var(--bg) 40%);color:var(--text);font:400 16px/1.55 var(--body-font);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;-webkit-tap-highlight-color:transparent;min-height:100dvh;display:flex;flex-direction:column}a{color:inherit}:where(button,a,input,select,textarea,[role=button],[tabindex]):focus-visible{outline:0;box-shadow:var(--focus-ring)}.container{max-width:var(--container);margin:0 auto;padding:0 16px;width:100%}.header{position:sticky;top:0;z-index:var(--z-header);background:var(--header-glass);backdrop-filter:blur(6px);border-bottom:1px solid var(--a-white-06)}.nav{display:flex;align-items:center;justify-content:space-between;gap:10px;min-height:66px;padding:6px 0;flex-wrap:nowrap}.logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.3px;min-width:0;flex:1 1 auto}.logo-img{height:34px;border-radius:5px;object-fit:cover;display:block;flex:0 0 auto}.nav-cta{display:flex;gap:10px;align-items:center;margin-left:auto;flex-wrap:nowrap}.btn{appearance:none;border:0;border-radius:12px;padding:10px 14px;background:var(--panel);color:var(--text-0);cursor:pointer;display:inline-flex;gap:8px;align-items:center;justify-content:center;box-shadow:var(--shadow);transition:transform var(--ui-duration) ease,opacity var(--ui-duration) ease,background .2s ease;user-select:none;white-space:nowrap}.btn:hover{transform:translateY(-2px)}.btn.brand{background:linear-gradient(90deg,var(--brand),var(--brand-2));color:var(--c-white);font-weight:700}.btn.ghost{background:var(--surface-2);border:1px solid var(--a-white-08);box-shadow:none}.btn.danger{background:var(--surface-danger);color:var(--danger-soft-text);border:1px solid var(--a-white-06)}.btn.sm{padding:8px 10px;border-radius:10px;font-size:13px}.btn.icon{padding:8px 10px;border-radius:10px;font-size:14px;box-shadow:none;background:var(--a-black-35);border:1px solid var(--a-white-15)}.btn:disabled{opacity:.55;cursor:not-allowed;transform:none}.btn.loading{pointer-events:none;opacity:.85;position:relative}.btn.loading::before{content:"";display:inline-block;width:14px;height:14px;border:2px solid var(--c-white);border-top-color:transparent;border-radius:50%;animation:spin .8s linear infinite;margin-right:8px}@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}.tag{display:inline-flex;gap:8px;align-items:center;background:var(--surface-12);border:1px solid var(--a-white-06);color:var(--text-7);border-radius:999px;padding:6px 10px;font-size:12px;white-space:nowrap}.hamburger{display:none}@media (max-width:var(--bp-mobile)){.nav{row-gap:8px;flex-direction:column;align-items:center}.nav-cta{display:none}.hamburger{display:inline-flex;margin-left:auto}.logo-img{width:30px;height:30px}.logo{justify-content:center;flex:none}.toolbar-top{flex-direction:column;align-items:stretch;gap:8px}.actions-row{flex-direction:row;justify-content:space-between}.search{width:100%}.view-toggle{justify-content:center;flex:1 1 auto}.btn.brand{flex:0 0 auto}}.account-panel,.menu-panel{position:fixed;top:66px;right:12px;z-index:var(--z-panel);width:min(360px,94vw);background:var(--surface-0);border:1px solid var(--a-white-08);border-radius:16px;box-shadow:0 20px 40px var(--a-black-50);transform-origin:top right;transform:scale(.98) translateY(-6px);opacity:0;pointer-events:none;transition:transform .2s ease,opacity .2s ease}.account-panel.open,.menu-panel.open{transform:scale(1) translateY(0);opacity:1;pointer-events:auto}.menu-sec{padding:12px;border-bottom:1px solid var(--a-white-06)}.menu-sec:last-child{border-bottom:0}.menu-title{font-family:var(--title-font);font-size:13px;color:var(--text-2);margin-bottom:8px}.menu-row{display:flex;flex-wrap:wrap;gap:8px}.menu-item{width:100%;display:flex;align-items:center;justify-content:space-between;gap:10px;background:var(--surface-1);border:1px solid var(--a-white-08);border-radius:12px;padding:10px 12px}.menu-kv{display:flex;align-items:center;gap:10px}.menu-note{font-size:12px;color:var(--muted)}.banner{position:relative;display:block;height:clamp(520px,70vw,880px);width:100vw;margin-left:calc(50% - 50vw);border-bottom:1px solid var(--a-white-06);overflow:hidden}.banner-image{position:absolute;inset:0;background-position:center;background-size:cover;background-repeat:no-repeat;opacity:1;filter:saturate(1.02) contrast(1.05) brightness(.9);transform:scale(1.02)}.banner::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,var(--banner-ov-1),var(--banner-ov-2) 40%,var(--banner-ov-3));pointer-events:none}.banner-inner{position:relative;z-index:2;height:100%;display:flex;align-items:flex-end;padding:96px 0 40px}.hero{display:grid;gap:10px;max-width:var(--container);margin:0 auto;width:100%;padding:0 16px}.hero-box{max-width:min(820px,96%);background:var(--hero-glass);border:1px solid var(--a-white-15);padding:14px 16px;border-radius:14px;box-shadow:0 14px 40px var(--a-black-45);backdrop-filter:blur(4px)}.hero h1{margin:0 0 6px 0;font-size:clamp(22px, 3.2vw, 38px);line-height:1.1;letter-spacing:.6px;font-family:var(--title-font);font-weight:700;text-shadow:0 2px 6px var(--a-black-55)}.hero .sub{color:var(--text-5);font-size:14px;text-shadow:0 1px 4px var(--a-black-50)}.toolbar{display:flex;flex-direction:column;gap:12px;margin:14px 0 10px}.toolbar-top{display:flex;gap:10px;flex-wrap:wrap;align-items:center}.actions-row{display:flex;gap:10px;align-items:center;flex-wrap:nowrap}.search-container{position:relative;flex:1;min-width:220px}.search{width:100%;background:var(--surface-3);border:1px solid var(--a-white-08);border-radius:12px;color:var(--text-1);padding:10px 40px 10px 12px;outline:0}.search:focus{box-shadow:var(--focus-ring);border-color:var(--brand-a70)}.search-clear{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:0 0;border:none;color:var(--muted);cursor:pointer;font-size:16px;display:none}.search-clear.visible{display:block}.toolbar-tabs{display:flex;gap:8px;flex-wrap:nowrap;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch;scrollbar-width:none}.toolbar-tabs::-webkit-scrollbar{display:none}.tab{padding:8px 12px;border-radius:999px;color:var(--text-3);background:var(--surface-4);border:1px solid var(--a-white-06);cursor:pointer;transition:transform .15s;flex:0 0 auto}.tab:hover{transform:translateY(-1px)}.tab.active{background:linear-gradient(90deg,var(--brand-a25),var(--brand-2-a20));color:var(--c-white);border-color:var(--a-white-12)}.tab .count{opacity:.7;margin-left:6px}.sort-toggle,.view-toggle{display:inline-flex;background:var(--surface-5);border:1px solid var(--a-white-06);border-radius:12px;overflow:hidden}.seg{appearance:none;background:0 0;color:var(--text-4);padding:8px 12px;border:0;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px}.seg:hover{background:var(--a-white-04)}.seg.active{background:linear-gradient(90deg,var(--brand-a25),var(--brand-2-a20));color:var(--c-white)}.toolbar .toolbar-top .view-toggle{margin-left:auto}.section{margin-top:18px}.section-title{display:flex;align-items:center;gap:10px;margin:8px 0 10px;font-family:var(--title-font);font-size:18px;letter-spacing:.3px;color:var(--text-6)}.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}.col{grid-column:span 12}.grid.view-grid .col{grid-column:span 6}@media (min-width:540px){.grid.view-grid .col{grid-column:span 4}}@media (min-width:780px){.grid.view-grid .col{grid-column:span 3}}@media (min-width:1024px){.grid.view-grid .col{grid-column:span 3}}.grid.view-compact .col{grid-column:span 12}@media (min-width:900px){.grid.view-compact .col{grid-column:span 6}}@media (min-width:1200px){.grid.view-compact .col{grid-column:span 4}}.card{background:var(--surface-1);border:1px solid var(--a-white-08);border-radius:var(--radius);overflow:hidden;box-shadow:0 8px 20px var(--deep-shadow);display:flex;flex-direction:column;min-width:0;position:relative}.cover{position:relative;width:100%;aspect-ratio:1/1.4;background:var(--surface-6);overflow:hidden}.cover img{width:100%;height:100%;object-fit:cover;display:block}.cover .ph{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--surface-7),var(--surface-8));color:var(--text-9);font-weight:800;font-size:clamp(22px, 5vw, 36px);letter-spacing:.8px;text-transform:uppercase}.cover-loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none;background:linear-gradient(180deg,var(--a-black-0),var(--a-black-25))}.cover-loader i{color:var(--brand-2);font-size:18px;animation:spin .8s linear infinite;filter:drop-shadow(0 2px 6px var(--a-black-50))}.floating-actions{position:absolute;top:6px;right:6px;display:flex;gap:6px;z-index:2}.floating-actions .icon-btn{background:var(--ink-70);color:var(--text-1);border:1px solid var(--a-white-15);padding:6px;border-radius:8px;cursor:pointer}.floating-actions .icon-btn:hover{background:var(--ink-90)}.badge-bottom{position:absolute;right:6px;bottom:6px;background:var(--a-black-55);border:1px solid var(--a-white-12);color:var(--text-11);font-size:11px;padding:4px 6px;border-radius:999px;display:flex;gap:6px;align-items:center;z-index:1}.note-tooltip{position:absolute;left:8px;right:56px;bottom:8px;background:var(--a-black-62);border:1px solid var(--a-white-12);color:var(--text-11);padding:8px 10px;border-radius:12px;font-size:12px;line-height:1.35;opacity:0;transform:translateY(6px);transition:opacity var(--ui-duration) ease,transform var(--ui-duration) ease;pointer-events:none;z-index:3;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:5;overflow:hidden}.card.has-note.note-open .note-tooltip,.card.has-note:hover .note-tooltip{opacity:1;transform:translateY(0)}.card-body{padding:8px;min-width:0;display:flex;flex-direction:column;gap:6px}.title-row{display:grid;grid-template-columns:1fr;align-items:center;gap:6px;min-width:0}.title{font-weight:800;letter-spacing:.5px;font-family:var(--title-font);font-size:14px;line-height:1.2;min-width:0;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-box-orient:vertical;-webkit-line-clamp:2;height:2.4em}.chips{display:flex;gap:6px;flex-wrap:wrap;align-items:center;color:var(--text-8);font-size:11px;margin:2px 0 4px}.chip{font-size:10px;padding:3px 6px;border-radius:999px;background:var(--chip-bg);border:1px solid var(--a-white-08);color:var(--text-4)}.controls{display:flex;align-items:center;gap:6px;margin-top:2px;flex-wrap:wrap}.control-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:32px;border-radius:8px;background:var(--surface-9);color:var(--text-10);border:1px solid var(--a-white-12);cursor:pointer;flex:0 0 auto}.control-btn:hover{background:var(--surface-10)}.control-btn:disabled{opacity:.35;cursor:not-allowed}.progress-readout{display:inline-flex;gap:6px;align-items:center;padding:6px 10px;border-radius:8px;background:var(--surface-11);border:1px solid var(--a-white-08);font-size:12px;color:var(--text-4);flex:0 0 auto;min-width:max-content;max-width:100%}.progress-readout .spin{animation:spin .9s linear infinite;color:var(--brand-2)}.move-select,.select{appearance:none;background-color:var(--surface-3);border:1px solid rgba(255,255,255,.1);border-radius:12px;color:var(--text-1);padding:10px 38px 10px 12px;outline:0;height:38px;line-height:1;position:relative;cursor:pointer;box-shadow:none;background-image:linear-gradient(180deg,var(--a-white-06),var(--a-white-0) 40%),linear-gradient(45deg,transparent 50%,var(--select-arrow) 50%),linear-gradient(135deg,var(--select-arrow) 50%,transparent 50%);background-repeat:no-repeat,no-repeat,no-repeat;background-position:0 0,calc(100% - 18px) 50%,calc(100% - 12px) 50%;background-size:auto,6px 6px,6px 6px}.move-select{height:32px;padding:6px 34px 6px 8px;border-radius:8px;margin-left:auto}@media (max-width:520px){.controls{display:grid;grid-template-columns:32px max-content 32px;align-items:center;gap:6px}.control-btn{height:28px;padding:0}.progress-readout{padding:4px 8px;font-size:12px;min-width:max-content;justify-self:center}.move-select{grid-column:1/-1;width:100%;margin-left:0}}.muted{color:var(--muted)}.muted-small{color:var(--muted);font-size:13px}.card.row{flex-direction:row;align-items:stretch;gap:0;flex-wrap:nowrap!important;position:relative}.card.row .cover{width:80px;flex:0 0 80px;aspect-ratio:1/1.4}.card.row .badge-bottom{display:none}.card.row .card-body{padding:8px 10px;gap:6px}.card.row .chips{margin:2px 0 2px}.card.row .title{height:2.4em}.card.row .controls{margin-top:2px}.card.row .floating-actions{top:6px;right:6px}.modal{position:fixed;inset:0;background:var(--modal-overlay);display:none;align-items:center;justify-content:center;padding:16px;z-index:var(--z-modal);transition:opacity var(--ui-duration) ease}.modal.open{display:flex}#chat-modal{z-index:var(--z-chat)}#auth-modal{z-index:var(--z-auth)}#confirm-modal{z-index:var(--z-confirm)}#offline-modal{z-index:var(--z-offline)}.chat-sheet{background:var(--surface-16)!important}.sheet{background:var(--surface-15);border:1px solid var(--a-white-08);border-radius:14px;width:min(820px,98%);padding:18px;transform:translateY(8px) scale(.995);opacity:0;transition:transform .28s cubic-bezier(.2, .9, .3, 1),opacity .2s ease}.sheet>.chat-body{background:radial-gradient(circle at center,var(--surface-14) 0,var(--surface-15) 80%)}.modal.open .sheet{transform:translateY(0) scale(1);opacity:1}.sheet h3{margin:0 0 8px;font-family:var(--title-font)}.form{display:grid;gap:10px}.row{display:flex;gap:10px;flex-wrap:wrap}.input-wrapper{position:relative;flex:1;min-width:0}.file,.input,.select{background-color:var(--surface-14);border:1px solid var(--a-white-08);border-radius:12px;color:var(--text-1);outline:0;width:100%}.input,.select{padding:12px 12px}.input:focus,.select:focus{box-shadow:var(--focus-ring);border-color:var(--brand-a70)}.float-group{position:relative;flex:1 1 auto;min-width:0}.float-group .field{position:relative;min-width:0}.float-group label{position:absolute;left:12px;top:50%;transform:translateY(-50%);pointer-events:none;color:var(--text-2);font-size:13px;line-height:1.1;font-family:var(--title-font);letter-spacing:.3px;margin:0;opacity:.92;transition:top var(--ui-duration) ease,transform var(--ui-duration) ease,font-size var(--ui-duration) ease,color var(--ui-duration) ease,opacity var(--ui-duration) ease}.float-group.filled label,.float-group:focus-within label{top:8px;transform:none;font-size:11px;opacity:.96;color:var(--text-0)}.float-group .input{padding:18px 40px 10px 12px}.float-group .select.input{padding-right:44px}.float-group.stepper .input{text-align:center;padding:18px 44px 10px 44px}.stepper-btn{position:absolute;top:50%;transform:translateY(-50%);width:32px;height:32px;border-radius:10px;border:1px solid var(--a-white-12);background:var(--a-white-06);color:var(--text-1);cursor:pointer;display:inline-flex;align-items:center;justify-content:center;z-index:2}.stepper-btn.dec{left:8px}.stepper-btn.inc{right:8px}.stepper-btn:disabled{opacity:.35;cursor:not-allowed}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield}.clear-btn{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:var(--a-white-06);border:1px solid var(--a-white-12);color:var(--text-muted-4);cursor:pointer;font-size:12px;width:24px;height:24px;border-radius:6px;display:none;align-items:center;justify-content:center;z-index:3}.clear-btn.visible{display:inline-flex}.hint{color:var(--muted);font-size:12px}.danger-text{color:var(--danger)}.small{font-size:12px}.modal-divider{border:0;height:2px;border-radius:999px;margin:12px 0;background:linear-gradient(90deg,transparent,var(--brand-a75) 20%,var(--brand-2-a75) 80%,transparent);filter:drop-shadow(0 2px 10px rgba(124, 58, 237, .22));opacity:.95}.text-link{color:var(--text-link);font-size:13px;cursor:pointer;text-decoration:none;user-select:none;background:0 0;border:none;padding:0}.text-link:hover{text-decoration:underline}#toasts{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:10px;z-index:var(--z-toast)}.toast{min-width:220px;max-width:420px;padding:12px 14px;border-radius:12px;box-shadow:0 10px 30px var(--a-black-45);color:var(--c-white);font-weight:700;display:flex;gap:10px;align-items:center;transform:translateY(10px) scale(.995);opacity:0}.toast .msg{font-weight:700;font-size:14px;white-space:normal}.toast{display:flex!important;align-items:center!important;gap:10px!important;white-space:normal!important}.toast *{white-space:normal!important;min-width:0!important;max-width:100%!important;flex-shrink:1!important;overflow-wrap:break-word!important;word-break:break-word!important;display:block!important}.toast.info{background:var(--toast-info)}.toast.success{background:linear-gradient(90deg,var(--green-600),var(--ok))}.toast.error{background:linear-gradient(90deg,var(--danger),var(--danger-2))}.toast.enter{animation:toast-in .26s cubic-bezier(.2,.9,.3,1) forwards}.toast.exit{animation:toast-out .3s ease forwards}@keyframes toast-in{to{transform:translateY(0) scale(1);opacity:1}}@keyframes toast-out{to{transform:translateY(8px) scale(.98);opacity:0}}#cover-progress{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:var(--z-cover-progress);width:320px;max-width:90vw;padding:12px 14px;border-radius:14px;border:1px solid var(--a-white-14);background:var(--cover-progress-bg);backdrop-filter:blur(8px);box-shadow:0 18px 44px var(--a-black-50);display:none}#cover-progress.visible{display:flex;align-items:center;justify-content:center}#cover-progress.success{background:linear-gradient(90deg,var(--green-600),var(--ok))}#cover-progress .cp-text{text-align:center;font-weight:800;color:var(--c-white);display:inline-flex;align-items:center;gap:10px}#cover-progress .cp-text b{font-variant-numeric:tabular-nums}#cover-progress .cp-text i.spin{animation:spin .9s linear infinite}footer{border-top:1px solid var(--a-white-08);margin-top:auto;background:var(--panel)}footer .foot-wrap{display:flex;justify-content:space-between;align-items:center;gap:16px;padding:22px 0 26px;flex-wrap:wrap}.foot-left{display:flex;align-items:center;gap:12px;min-width:0}.foot-brand{display:flex;flex-direction:column;gap:4px;min-width:0}.foot-brand-top{display:flex;align-items:center;gap:10px;min-width:0}.foot-brand-top i{opacity:.7;flex:0 0 auto}.foot-brand-name{font-family:var(--title-font);letter-spacing:.4px;font-size:15px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.foot-right{display:flex;align-items:center;justify-content:flex-end;gap:10px}.socials{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.social-link{width:25px;height:25px;display:inline-flex;align-items:center;justify-content:center;text-decoration:none;transition:transform .2s ease,background .2s ease,border-color .2s ease}.social-link i{color:var(--c-white);font-size:16px;line-height:1}.social-link:hover{transform:translateY(-2px);border-color:var(--a-white-18)}.social-link:hover i{color:var(--accent-2)}.center{display:flex;align-items:center;justify-content:center}.hidden{display:none!important}.section-divider{border:0;height:3px;border-radius:999px;margin:24px 0;background:linear-gradient(90deg,transparent,var(--brand-a70) 20%,var(--brand-2-a70) 80%,transparent);filter:drop-shadow(0 2px 10px rgba(124, 58, 237, .25))}#loading-spinner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:var(--z-loading);display:none;color:var(--brand);font-size:24px;animation:spin 1s linear infinite}#loading-spinner.active{display:block}#scroll-to-top i{font-size:20px}#scroll-to-top{position:fixed;width:50px;height:50px;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:var(--page-accent-dark);bottom:30px;right:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:22px;z-index:var(--z-scrolltop);border:1px solid var(--stroke);-webkit-tap-highlight-color:transparent;transition:all .2s ease;transform:translateY(8px) scale(.95);opacity:0;pointer-events:none}#scroll-to-top.visible{pointer-events:auto;opacity:1;transform:translateY(0) scale(1)}#scroll-to-top.visible:hover{transform:translateY(-3px) scale(1.03);box-shadow:0 3px 12px var(--brand-2-a45),0 0 14px var(--accent-2-a35)}#scroll-to-top.visible:active{transform:translateY(1px) scale(.93)}@media (max-width:600px){#scroll-to-top{height:40px;width:40px;font-size:18px;right:calc(50vw - 20px);bottom:18px}}@media (max-width:var(--bp-mobile)){.hero h1{font-size:22px}.toolbar-top{gap:8px}.card.row .cover{width:68px;flex:0 0 68px}footer .foot-wrap{flex-direction:column;text-align:center}.foot-right{justify-content:center}.view-toggle .seg span{display:none}.view-toggle .seg{padding:8px}}@media (prefers-reduced-motion:reduce){*{transition:none!important;animation:none!important}html{scroll-behavior:auto}}::selection{background:var(--accent-2);color:var(--c-black)}.skeleton-card{background:var(--surface-1);border:1px solid var(--a-white-08);border-radius:var(--radius);overflow:hidden;box-shadow:0 8px 20px var(--deep-shadow);display:flex;flex-direction:column;animation:pulse 1.5s infinite ease-in-out}.skeleton-cover{width:100%;height:0;padding-bottom:140%;background:linear-gradient(90deg,var(--surface-6) 25%,var(--surface-1) 50%,var(--surface-6) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite}.skeleton-body{padding:8px;display:flex;flex-direction:column;gap:6px}.skeleton-title{height:1.2em;width:80%;background:var(--surface-9);border-radius:4px}.skeleton-chip{height:1em;width:60%;background:var(--surface-9);border-radius:4px}.skeleton-controls{display:flex;gap:6px}.skeleton-btn{height:32px;width:36px;background:var(--surface-9);border-radius:8px}@keyframes pulse{0%{opacity:.85}50%{opacity:.6}100%{opacity:.85}}@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}.tab-group{display:flex;gap:8px;margin-bottom:12px}.tab-btn{flex:1;padding:8px;border-radius:8px;background:var(--surface-1);border:1px solid var(--a-white-06);color:var(--text-3);cursor:pointer}.tab-btn.active{background:linear-gradient(90deg,var(--brand-a25),var(--brand-2-a20));color:var(--c-white)}.account-panel{padding:0;overflow:hidden}.account-header{display:flex;align-items:center;gap:12px;padding:14px;background:linear-gradient(135deg,var(--brand-a22),var(--brand-2-a15));border-bottom:1px solid var(--a-white-08)}.account-avatar{width:44px;height:44px;border-radius:10px;background:var(--surface-9);display:flex;align-items:center;justify-content:center;font-weight:900;font-family:var(--title-font);letter-spacing:.5px;color:var(--text-0);border:1px solid var(--a-white-15);background-size:cover;background-position:center;overflow:hidden;flex:0 0 auto}.account-id .name{font-family:var(--title-font);font-size:15px;letter-spacing:.3px;color:var(--text-0)}.account-id .email{font-size:12px;color:var(--text-muted-1);opacity:.9}.account-stats{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;padding:12px}.stat-card{background:var(--surface-1);border:1px solid var(--a-white-08);border-radius:12px;padding:10px 12px}.stat-label{font-size:12px;color:var(--text-muted-2);display:flex;gap:8px;align-items:center}.stat-value{font-size:20px;font-weight:800;color:var(--stat-value-default);margin-top:2px}.stat-card.total .stat-value{color:var(--accent-2)}.stat-card.watch .stat-value{color:var(--accent-1)}.stat-card.online .stat-value{color:var(--green-soft)}.account-actions{padding:12px;border-top:1px solid var(--a-white-06);display:flex;flex-wrap:wrap;gap:8px}.account-pref{padding:12px;border-top:1px solid var(--a-white-06);display:grid;gap:12px}.preloader{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:radial-gradient(1200px 600px at 50% 30%,var(--brand-a10),transparent 70%),var(--preloader-overlay);z-index:var(--z-preloader)}.preloader.active{display:flex}.preloader-inner{display:grid;gap:14px;place-items:center;text-align:center;padding:20px}.preloader-logo{font-family:var(--title-font);font-weight:900;letter-spacing:1px;font-size:20px;color:var(--text-0)}.preloader-spinner{width:38px;height:38px;border-radius:50%;border:3px solid var(--a-white-20);border-top-color:var(--accent-2);animation:spin .9s linear infinite;filter:drop-shadow(0 4px 12px var(--accent-2-a35))}.preloader-msg{color:var(--text-2);font-size:13px}.no-results{border:1px dashed var(--a-white-25);border-radius:12px;padding:16px;text-align:left;color:var(--text-2);margin:10px 0;background:linear-gradient(180deg,var(--surface-3),var(--surface-13))}.no-results-row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}.no-results-text{font-family:var(--title-font);font-size:18px;font-weight:700;letter-spacing:.35px;color:var(--text-0)}@media (max-width:520px){.no-results-row{flex-direction:column;align-items:stretch}.no-results-row .btn{width:100%;justify-content:center}}.upload-zone{border:1px dashed var(--a-white-18);border-radius:12px;padding:14px;background:var(--a-white-02);display:grid;gap:10px}.chat-sheet{width:min(820px,98%);display:grid;grid-template-rows:auto 1fr auto auto;max-height:86dvh;font-family:var(--chat-font)}.chat-header{display:flex;align-items:center;gap:10px;justify-content:space-between;margin-bottom:10px}.chat-title{display:flex;align-items:center;gap:10px;font-family:var(--title-font);letter-spacing:.4px}.chat-presence{margin-left:auto;margin-right:8px}.chat-body{position:relative;overflow:auto;background:var(--surface-3);border:1px solid var(--a-white-06);border-radius:12px;padding:10px;min-height:360px}.chat-loading{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:var(--a-black-25);z-index:2}.chat-loading.visible{display:flex}.chat-composer{display:grid;grid-template-columns:34px 1fr auto;gap:8px;align-items:stretch;margin-top:10px}.chat-avatar{width:34px;height:34px;border-radius:8px;border:1px solid var(--a-white-12);background:var(--surface-0);object-fit:cover;align-self:end}.chat-input{resize:none;min-height:38px;max-height:140px;font-family:var(--chat-font)}#chat-send{width:50px;height:42px;justify-content:center}#chat-send:disabled{opacity:.6;cursor:not-allowed}.msg{display:grid;grid-template-columns:32px 1fr;gap:8px;margin:6px 0;align-items:start}.msg.mine{grid-template-columns:1fr 32px}.msg .avatar{width:32px;height:32px;border-radius:8px;border:1px solid var(--a-white-12);background:var(--surface-0);object-fit:cover}.msg.mine .avatar{grid-column:2}.bubble{background:var(--surface-1);border:1px solid var(--a-white-08);border-radius:10px;padding:8px 10px;display:inline-block;width:fit-content;max-width:90%;justify-self:start}.msg.mine .bubble{background:linear-gradient(90deg,var(--brand-a18),var(--brand-2-a12));border-color:rgba(255,255,255,.1);justify-self:end}.msg.susie .bubble{background:linear-gradient(90deg,var(--susie-a40),var(--susie-a30));border-color:var(--susie-a60)}.msg.susie .avatar{border-color:var(--susie-a60)}.meta{display:flex;gap:8px;align-items:center;color:var(--text-muted-2);font-size:12px;margin-bottom:4px}.meta .user{font-weight:800}.meta .time{color:var(--text-muted-3);font-variant-numeric:tabular-nums}.content{white-space:pre-wrap;word-break:break-word;color:var(--text-1)}.content a{color:var(--text-link);text-decoration:underline}.content-chunk{white-space:pre-wrap}.content-chunk.enter{opacity:0;transform:translateY(4px)}.content-chunk.enter.active{opacity:1;transform:translateY(0);transition:opacity 180ms ease,transform 180ms ease}.chat-readmore{margin-top:6px;display:inline-flex;align-items:center;gap:8px}.chat-bottom-fab{position:absolute;right:12px;bottom:12px;z-index:3;display:none;background:linear-gradient(135deg,var(--accent-1),var(--accent-2));color:var(--page-accent-dark);border:none;border-radius:999px;padding:8px 10px;box-shadow:var(--shadow);cursor:pointer}.chat-bottom-fab.visible{display:inline-flex}.chat-typing{position:absolute;left:10px;bottom:10px;background:var(--a-white-06);color:var(--text-2);border:1px solid var(--a-white-12);border-radius:999px;padding:4px 8px;font-size:12px;pointer-events:none;z-index:3;display:none}.chat-typing.visible{display:inline-flex}@media (max-width:520px){.chat-body{padding:8px}.chat-composer{grid-template-columns:28px 1fr auto}.chat-avatar{width:28px;height:28px}.msg{grid-template-columns:28px 1fr;gap:6px}.msg.mine{grid-template-columns:1fr 28px}.msg .avatar{width:28px;height:28px}#chat-send{width:44px}}#offline-modal{background:var(--modal-overlay-strong);backdrop-filter:blur(2px)}#offline-modal .sheet{position:relative;overflow:hidden;border-color:var(--warn-a55);background-color:var(--surface-15);background-image:linear-gradient(180deg,var(--offline-grad-1) 0,var(--offline-grad-2) 35%,var(--offline-grad-3) 70%,var(--offline-grad-4) 100%);box-shadow:0 24px 80px var(--a-black-65),0 0 0 1px var(--warn-a18)}#offline-modal .sheet::before{content:"";position:absolute;inset:-2px;background:radial-gradient(700px 260px at 30% 0,var(--warn-a28),transparent 60%);backdrop-filter:blur(6px);z-index:-1;pointer-events:none}#offline-modal h3 i{color:var(--warn)}.pfp-grid{margin-top:12px;display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:12px}@media (max-width:720px){.pfp-grid{grid-template-columns:repeat(3,minmax(0,1fr))}}@media (max-width:520px){.pfp-grid{grid-template-columns:repeat(2,minmax(0,1fr))}}.pfp-grid .skeleton-cover{padding-bottom:100%}.pfp-card{appearance:none;border:1px solid var(--a-white-08);background:var(--surface-1);border-radius:var(--radius);padding:0;overflow:hidden;cursor:pointer;box-shadow:0 8px 20px var(--deep-shadow);transition:transform 150ms ease,border-color 150ms ease,box-shadow 150ms ease;text-align:left}.pfp-card:hover{transform:translateY(-2px)}.pfp-card.selected{border-color:var(--accent-2-a85);box-shadow:0 0 0 4px var(--accent-2-a18),0 8px 20px var(--deep-shadow)}.pfp-cover{position:relative;aspect-ratio:1/1;background:var(--surface-6);overflow:hidden}.pfp-cover img{width:100%;height:100%;object-fit:cover;display:block}.pfp-load{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,var(--a-black-0),var(--a-black-25))}.pfp-load i{color:var(--brand-2);font-size:18px;animation:spin .8s linear infinite;filter:drop-shadow(0 2px 6px var(--a-black-50))}.pfp-meta{padding:8px 10px;font-size:11px;color:var(--muted);display:flex;justify-content:space-between;gap:8px}</style><div id=app-preloader class=preloader aria-hidden=true><div class=preloader-inner><div class=preloader-spinner aria-hidden=true></div><div class=preloader-logo>AniMehList</div><div id=preloader-msg class=preloader-msg>Warming up the ramen…</div></div></div><header class=header><div class="container nav"><div class=logo><img src=assets/wide_logo.png alt=AniMehList class=logo-img></div><div class=nav-cta id=auth-cta></div><button class="btn icon hamburger"id=btn-menu aria-haspopup=true aria-expanded=false aria-controls=mobile-menu title=Menu><i class="fa-solid fa-bars"></i></button></div><div class=menu-panel id=mobile-menu role=menu aria-label="Navigation menu"><div class=menu-sec><div class=menu-title>Quick actions</div><div class=menu-row><button class="btn brand"id=m-add><i class="fa-solid fa-plus"></i>Add item</button></div></div><div class=menu-sec><div class=menu-title>Community</div><div class=menu-row><div class=menu-item><div class=menu-kv><i class="fa-solid fa-comments"></i>Global Chat<span class=menu-note id=m-chat-online>(0 online)</span></div><button class="btn ghost sm"id=m-open-chat>Open</button></div></div></div><div class=menu-sec><div class=menu-title>View</div><div class=menu-row role=group aria-label="View toggle"><div class=menu-item><div class=menu-kv><i class="fa-solid fa-grip"></i>Grid</div><button class="btn ghost sm"id=m-view-grid>Use</button></div><div class=menu-item><div class=menu-kv><i class="fa-solid fa-list"></i>Shelf</div><button class="btn ghost sm"id=m-view-compact>Use</button></div></div></div><div class=menu-sec><div class=menu-title>Account</div><div class=menu-row><div class=menu-item id=m-auth-row><div class=menu-kv><i class="fa-solid fa-user"></i><span id=m-user-email>Signed out</span></div><button class="btn ghost sm"id=m-login><i class="fa-solid fa-right-to-bracket"></i>Sign in</button><button class="btn ghost sm hidden"id=m-logout><i class="fa-solid fa-right-from-bracket"></i>Sign out</button></div></div></div><div class=menu-sec><div class=menu-title>Data</div><div class=menu-row><button class="btn ghost sm"id=m-import><i class="fa-solid fa-file-import"></i>Import</button><button class="btn ghost sm"id=m-export><i class="fa-solid fa-file-export"></i>Export JSON</button><div class=menu-note>Import via MAL XML, AniList JSON or our JSON.</div></div></div></div><div class=account-panel id=account-panel aria-label="Account panel"><div class=account-header><div class=account-avatar id=account-avatar>U</div><div class=account-id><div class=name id=account-username></div><div class=email id=account-email></div></div></div><div class=account-stats><div class="stat-card total"><div class=stat-label><i class="fa-solid fa-layer-group"></i>Total Items</div><div class=stat-value id=account-total>0</div></div><div class="stat-card watch"><div class=stat-label><i class="fa-solid fa-eye"></i>Watching</div><div class=stat-value id=account-watching>0</div></div><div class="stat-card online"><div class=stat-label><i class="fa-solid fa-signal"></i>Online now</div><div class=stat-value id=account-online>0</div></div></div><div class=account-pref><div class="float-group input-wrapper"><div class=field><label for=pref-cover>Default cover source</label><select id=pref-cover class="select input"aria-label="Default cover source"><option value=ANILIST>AniList (Default — Recommended, high quality)<option value=JIKAN>Jikan (MAL) (Larger DB — lower quality / sometimes inaccurate)<option value=KITSU>Kitsu (High quality — often inaccurate)</select></div></div></div><div class=account-actions><button class="btn ghost sm"id=account-change-pfp><i class="fa-solid fa-id-badge"></i>Change profile pic</button><button class="btn ghost sm"id=account-export><i class="fa-solid fa-file-export"></i>Export JSON</button><button class="btn danger sm"id=account-clear-list><i class="fa-solid fa-bomb"></i>Clear list</button><button class="btn ghost sm"id=account-logout><i class="fa-solid fa-right-from-bracket"></i>Sign out</button></div></div></header><section class=banner aria-label=Featured><div class=banner-image id=banner-image aria-hidden=true></div><div class=banner-inner><div class="hero container"><div class=hero-box><h1 id=hero-title>AniMehList — Anime Watchlist For The Bros</h1><div class=sub>Fast. Private. Built for bros who binge and forget where they left off.</div></div></div></div></section><main class=container id=main><div class=toolbar><div class=toolbar-top><div class=search-container><input class=search id=search placeholder="Search title…"aria-label="Search titles (press / to focus)"><button class=search-clear id=search-clear aria-label="Clear search"><i class="fa-solid fa-xmark"></i></button></div><div class=actions-row><button class="btn brand"id=btn-add><i class="fa-solid fa-plus"></i>New</button></div></div><div class=toolbar-tabs id=tabs></div><div class=toolbar-top><div id=sort-toggle class=sort-toggle role=group aria-label="Sort by"><button class=seg data-sort=recent title=Newest><i class="fa-solid fa-clock"></i></button><button class=seg data-sort=az title=A–Z><i class="fa-solid fa-arrow-down-a-z"></i></button><button class=seg data-sort=za title=Z–A><i class="fa-solid fa-arrow-down-z-a"></i></button></div><div class=view-toggle role=group aria-label="View mode"><button class=seg id=view-btn-grid aria-pressed=true title=Grid><i class="fa-solid fa-grip"></i></button><button class=seg id=view-btn-compact aria-pressed=false title=Shelf><i class="fa-solid fa-list"></i></button></div></div></div><div id=empty style="display:none;margin:35px 16px 20px 16px;padding:12px 16px;font-size:.85rem;color:var(--text-empty);text-align:center;background:var(--a-white-03);border:1px dashed var(--a-white-20);border-radius:8px">Sign in to start your shelf.</div><br><div id=no-results class="no-results hidden"><div class=no-results-row><div class=no-results-text>No anime found!<span style=opacity:.5>( •_•)</span><p style=font-weight:400;margin:0;font-size:12px!important;opacity:.5>Try a different search or add a new entry.</div><button class="btn brand sm"id=no-results-new type=button style=margin-right:20px><i class="fa-solid fa-plus"></i>New</button></div></div><div id=sections></div><div class=grid id=grid></div><div class=foot style="margin:22px 0 30px;display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap"><div class="muted small">Pro tip: press / to search. Click -/+ to adjust EP (Shift = ±5). Use the gear to edit, trash to delete.</div><div class=right style=display:flex;gap:8px;flex-wrap:wrap><button class="btn ghost small"id=btn-import><i class="fa-solid fa-file-import"></i>Import</button><button class="btn ghost small"id=btn-export><i class="fa-solid fa-file-export"></i>Export JSON</button><button class="btn ghost small"id=btn-refresh-covers><i class="fa-solid fa-sync"></i>Refresh covers</button></div></div></main><div class=modal id=modal role=dialog aria-modal=true aria-hidden=true><div class=sheet role=document><h3 id=modal-title><i class="fa-solid fa-pen-to-square"></i>Add item</h3><div class=form><div class=row><div class="float-group input-wrapper"><div class=field><label for=f-title>Title</label><input id=f-title class=input aria-label=Title><button class=clear-btn id=clear-title aria-label="Clear title"><i class="fa-solid fa-xmark"></i></button></div></div></div><div class=row><div class="float-group input-wrapper"><div class=field><label for=f-kind>Series/Movie</label><select id=f-kind class="select input"aria-label=Kind><option value=SERIES selected>Series<option value=MOVIE>Movie</select></div></div><div class="float-group input-wrapper"><div class=field><label for=f-status>Category</label><select id=f-status class="select input"aria-label=Status><option value=WATCHING>WATCHING<option value=PLAN selected>PLAN<option value=REWATCH>REWATCH<option value=WAITING>WAITING<option value=COMPLETED>COMPLETED</select></div></div></div><div class=row><div class="float-group input-wrapper stepper"><div class=field><label for=f-season>Season #</label><button class="stepper-btn dec"id=season-dec type=button aria-label="Decrease season"><i class="fa-solid fa-minus"></i></button><input type=number id=f-season class=input inputmode=numeric aria-label="Season number"min=0><button class="stepper-btn inc"id=season-inc type=button aria-label="Increase season"><i class="fa-solid fa-plus"></i></button></div></div><div class="float-group input-wrapper stepper"><div class=field><label for=f-episode>Episode #</label><button class="stepper-btn dec"id=episode-dec type=button aria-label="Decrease episode"><i class="fa-solid fa-minus"></i></button><input type=number id=f-episode class=input inputmode=numeric aria-label="Episode number"min=0><button class="stepper-btn inc"id=episode-inc type=button aria-label="Increase episode"><i class="fa-solid fa-plus"></i></button></div></div></div><hr class=modal-divider aria-hidden=true><div class=row><div class="float-group input-wrapper"><div class=field><label for=f-image>Cover URL</label><input id=f-image class=input aria-label="Image URL"><button class=clear-btn id=clear-image aria-label="Clear image URL"><i class="fa-solid fa-xmark"></i></button></div></div></div><div class=row style=align-items:flex-end><button class="btn ghost"id=btn-autocover title="Auto fetch cover by title"style=flex:1><i class="fa-solid fa-wand-magic-sparkles"></i>Auto cover</button><div class="float-group input-wrapper"style=flex:1;min-width:180px><div class=field><label for=f-cover-source>Source</label><select id=f-cover-source class="select input"aria-label="Cover source override"><option value=""selected>Default<option value=ANILIST>AniList<option value=JIKAN>Jikan<option value=KITSU>Kitsu</select></div></div></div><hr class=modal-divider aria-hidden=true><div class=row><div class="float-group input-wrapper"><div class=field><label for=f-notes>Notes (optional)</label><input id=f-notes class=input aria-label=Notes><button class=clear-btn id=clear-notes aria-label="Clear notes"><i class="fa-solid fa-xmark"></i></button></div></div></div><div class=row><div style=display:flex;gap:8px;align-items:center><button class="btn brand"id=btn-save><i class="fa-solid fa-floppy-disk"></i>Save</button><button class="btn ghost"id=btn-cancel><i class="fa-solid fa-xmark"></i>Cancel</button></div><div style=margin-left:auto><button class="btn danger"id=btn-delete style=display:none><i class="fa-solid fa-trash"></i>Delete</button></div></div><div class=hint>Covers are stored in your DB for sync. Background cover fetching respects per-anime source overrides.</div></div></div></div><div class=modal id=auth-modal role=dialog aria-modal=true aria-hidden=true><div class=sheet role=document style=max-width:560px><h3 style=display:flex;align-items:center;gap:10px><i class="fa-solid fa-right-to-bracket"></i>Account</h3><div class=tab-group><button class="tab-btn active"id=tab-signin>Sign In</button><button class=tab-btn id=tab-signup>Sign Up</button></div><div class=form id=signin-form><div class=row><div class="float-group input-wrapper"><div class=field><label for=login-identifier>Username or email</label><input id=login-identifier class=input aria-label="Username or email"></div></div></div><div class=row><div class="float-group input-wrapper"><div class=field><label for=login-password>Password</label><input id=login-password class=input type=password aria-label=Password></div></div></div><div class=row style=margin-top:-4px><button class=text-link id=forgot-password type=button>Forgot password?</button></div><div class=row style=justify-content:space-between;align-items:center><button class="btn brand"id=login-send><i class="fa-solid fa-right-to-bracket"></i>Sign in</button><button class="btn ghost"id=auth-close><i class="fa-solid fa-xmark"></i>Close</button></div></div><div class="form hidden"id=signup-form><div class=row><div class="float-group input-wrapper"><div class=field><label for=signup-username>Username</label><input id=signup-username class=input aria-label=Username></div></div></div><div class=row><div class="float-group input-wrapper"><div class=field><label for=signup-email>Email</label><input id=signup-email class=input type=email aria-label=Email></div></div></div><div class=row><div class="float-group input-wrapper"><div class=field><label for=signup-password>Password</label><input id=signup-password class=input type=password aria-label=Password></div></div></div><div class=row style=margin-top:-4px><button class=text-link id=resend-confirmation type=button>Resend confirmation email</button></div><div class=row style=justify-content:space-between;align-items:center><button class="btn brand"id=signup-send><i class="fa-solid fa-user-plus"></i>Sign up</button><button class="btn ghost"id=auth-close-2><i class="fa-solid fa-xmark"></i>Close</button></div></div></div></div><div class=modal id=verify-modal role=dialog aria-modal=true aria-hidden=true data-static=true><div class="sheet center"style=max-width:520px><div style=width:100%><h3><i class="fa-solid fa-circle-check"></i>Email verified</h3><p class=muted-small>Your email is verified. Return to your original tab and sign in with your username/email and password.<div style=display:flex;gap:8px;justify-content:flex-end;margin-top:12px><button class="btn brand"id=verify-reload><i class="fa-solid fa-rotate-right"></i>Reload</button></div></div></div></div><div class=modal id=offline-modal role=dialog aria-modal=true aria-hidden=true data-static=true><div class=sheet role=document style=max-width:520px><h3><i class="fa-solid fa-wifi"></i>You’re offline</h3><p class=muted-small>Your connection dropped. AniMehList will sync again automatically when you’re back online.<p class=hint>Tip: keep this tab open — no need to reload.</div></div><div class=modal id=confirm-modal role=dialog aria-modal=true aria-hidden=true><div class="sheet center"style=max-width:520px><div style=width:100%><h3 id=confirm-title><i class="fa-solid fa-triangle-exclamation"></i>Confirm</h3><p id=confirm-msg class=muted-small>Are you sure?<div style=display:flex;gap:8px;justify-content:flex-end;margin-top:12px><button class="btn ghost"id=confirm-cancel><i class="fa-solid fa-xmark"></i>Cancel</button><button class="btn danger"id=confirm-ok><i class="fa-solid fa-check"></i>Yes, do it</button></div></div></div></div><div class=modal id=import-modal role=dialog aria-modal=true aria-hidden=true><div class=sheet role=document style=max-width:640px><h3><i class="fa-solid fa-file-import"></i>Import your list</h3><div class=form><div class=row><div class="float-group input-wrapper"><div class=field><label for=import-format>Import type</label><select id=import-format class="select input"aria-label="Import type"><option value=MAL>MyAnimeList (MAL) — XML<option value=ANILIST>AniList — JSON<option value=APP selected>AniMehList (AML) — JSON</select></div></div></div><div class=upload-zone><input type=file id=import-picker class=hidden accept=.xml,.json,application/json,text/xml><button class="btn ghost"id=import-browse><i class="fa-solid fa-upload"></i>Choose file</button><div class=muted-small id=import-file-name>No file selected</div></div><div class=row style=justify-content:flex-end><button class="btn brand"id=import-run><i class="fa-solid fa-cloud-arrow-up"></i>Import</button><button class="btn ghost"id=import-cancel><i class="fa-solid fa-xmark"></i>Cancel</button></div><div class=hint>We’ll map statuses/kinds and fetch missing covers in the background.</div></div></div></div><div class=modal id=chat-modal role=dialog aria-modal=true aria-hidden=true><div class="sheet chat-sheet"role=document><div class=chat-header><div class=chat-title><i class="fa-solid fa-comments"></i>Global Chat</div><span class="tag chat-presence"id=chat-presence><i class="fa-solid fa-circle"style=color:var(--ok);font-size:8px></i><span id=chat-presence-text>0 online</span></span><button class="btn ghost sm"id=chat-close><i class="fa-solid fa-xmark"></i>Close</button></div><div id=chat-messages class=chat-body role=log aria-live=polite><div class=chat-loading id=chat-loading><i class="fa-solid fa-spinner spin"style=font-size:20px></i></div><button class=chat-bottom-fab id=chat-bottom-fab title="Jump to bottom"><i class="fa-solid fa-arrow-down"></i></button><div class=chat-typing id=chat-typing>Someone is typing…</div><div id=chat-list></div><div id=chat-end aria-hidden=true></div></div><div class=chat-composer><img id=chat-self-avatar class=chat-avatar alt=""><textarea id=chat-input class="input chat-input"placeholder="Type a message…"rows=1></textarea><button id=chat-send class="btn brand"title=Send><i class="fa-solid fa-paper-plane"></i></button></div><div class=muted-small style=margin-top:10px>The server keeps the latest 3000 messages.</div></div></div><div class=modal id=pfp-modal role=dialog aria-modal=true aria-hidden=true><div class=sheet role=document style=max-width:760px><h3><i class="fa-solid fa-id-badge"></i>Change profile picture</h3><p class=muted-small style=margin-top:-2px>Pick a new Dicebear avatar (same style). Regenerate is spam-safe and avoids duplicates per user.<div id=pfp-grid class=pfp-grid aria-label="Avatar options"></div><div class=row style=justify-content:space-between;align-items:center;margin-top:12px><button class="btn ghost"id=pfp-regenerate><i class="fa-solid fa-arrows-rotate"></i>Regenerate</button><div style=display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap><button class="btn brand"id=pfp-confirm type=button disabled><i class="fa-solid fa-check"></i>Confirm new pfp</button><button class="btn ghost"id=pfp-cancel type=button><i class="fa-solid fa-xmark"></i>Cancel</button></div></div><div class=hint>Tip: your chosen avatar is stored in your profile (syncs across devices).</div></div></div><div id=toasts aria-live=polite></div><div id=cover-progress role=status aria-live=polite><div class=cp-text id=cover-progress-text><i class="fa-solid fa-spinner spin"></i>Fetching covers…<b id=cover-progress-count>0 / 0</b></div></div><div id=loading-spinner aria-label=Loading><i class="fa-solid fa-spinner"></i></div><button id=scroll-to-top aria-label="Scroll to top"><i class="fa-solid fa-angle-up"></i></button><footer><div class="container foot-wrap"><div class=foot-left><div class=foot-brand><div class=foot-brand-top><i class="fa-solid fa-layer-group"aria-hidden=true></i><div class=foot-brand-name>AniMehList</div></div><div class=muted-small>© AniMehList<br>Made with ramen & chaos.</div></div></div><div class="foot-right socials"aria-label="Social links"><a class=social-link href=https://github.com/TheAnonymousCrusher/AniMehList target=_blank rel="noopener noreferrer"aria-label="AniMehList GitHub repository"title=GitHub><i class="fa-brands fa-github"></i></a></div></div></footer><script type=module>const SUPABASE_URL="https://dgmjnqrrdsbpuzqwaqra.supabase.co",SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRnbWpucXJyZHNicHV6cXdhcXJhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxMjcwNTksImV4cCI6MjA4MjcwMzA1OX0.rQpapzxl8o0NUnIynqNQeoeQbS9js6zHMVmKnsj7VTc";import{createClient}from"https://esm.sh/@supabase/supabase-js@2";const supabase=createClient(SUPABASE_URL,SUPABASE_ANON_KEY),STATUSES=["WATCHING","PLAN","REWATCH","WAITING","COMPLETED"],TABS=[{id:"ALL",label:"All"},{id:"WATCHING",label:"Watching"},{id:"PLAN",label:"Plan to watch"},{id:"REWATCH",label:"Rewatch"},{id:"WAITING",label:"Waiting"},{id:"COMPLETED_SERIES",label:"Completed (Series)"},{id:"COMPLETED_MOVIES",label:"Completed (Movies)"}],VIEWS=["grid","compact"],SORTS=["recent","az","za"],SUSIE_NAME="Susie the Ghost",SUSIE_AVATAR="assets/susie.png";let session=null,user=null,profile=null,data=[],activeTab="ALL",q="",viewMode="grid",sortMode="recent",presenceCount=0,defaultCoverSource="ANILIST",changesChannel=null,presenceChannel=null,chatChannel=null,typingChannel=null,editingId=null;const coverQueue=new Set,coverAttemptedThisRun=new Set;let coverWorkerRunning=!1,coverWorkerActive=0,coverTotal=0,coverDone=0,chatCooldownUntil=0,chatCooldownTimer=null,chatSending=!1;const typingUsers=new Map;let typingUiDebounce=null,typingLastBroadcastAt=0,typingBroadcastTimer=null,scrollTopInactivityTimer=null,lastHiddenAt=null,wakeRefreshInFlight=null,lastWakeRefreshAt=0,sessionRefreshInFlight=null,lastSessionRefreshAt=0,didEmptyEntriesRetryFix=!1;const entrySyncing=new Set,entryPending=new Map;let uiPrefsSaveTimer=null,lastSavedUiPrefs=null,avatarSeedHistory=new Set;const sectionsEl=document.getElementById("sections"),gridEl=document.getElementById("grid"),tabsEl=document.getElementById("tabs"),searchEl=document.getElementById("search"),searchClear=document.getElementById("search-clear"),btnAdd=document.getElementById("btn-add"),authCta=document.getElementById("auth-cta"),bannerImage=document.getElementById("banner-image"),emptyEl=document.getElementById("empty"),noResultsEl=document.getElementById("no-results"),noResultsNewBtn=document.getElementById("no-results-new"),loadingSpinner=document.getElementById("loading-spinner"),btnRefreshCovers=document.getElementById("btn-refresh-covers"),coverProgressEl=document.getElementById("cover-progress"),coverProgressText=document.getElementById("cover-progress-text"),viewBtnGrid=document.getElementById("view-btn-grid"),viewBtnCompact=document.getElementById("view-btn-compact"),sortToggle=document.getElementById("sort-toggle"),menuBtn=document.getElementById("btn-menu"),mobileMenu=document.getElementById("mobile-menu"),mAdd=document.getElementById("m-add"),mViewGrid=document.getElementById("m-view-grid"),mViewCompact=document.getElementById("m-view-compact"),mLogin=document.getElementById("m-login"),mLogout=document.getElementById("m-logout"),mUserEmail=document.getElementById("m-user-email"),mImport=document.getElementById("m-import"),mExport=document.getElementById("m-export"),mOpenChat=document.getElementById("m-open-chat"),mChatOnline=document.getElementById("m-chat-online"),accountPanel=document.getElementById("account-panel"),accountUsername=document.getElementById("account-username"),accountEmail=document.getElementById("account-email"),accountTotal=document.getElementById("account-total"),accountWatching=document.getElementById("account-watching"),accountLogout=document.getElementById("account-logout"),accountAvatar=document.getElementById("account-avatar"),accountOnline=document.getElementById("account-online"),accountExport=document.getElementById("account-export"),accountClearList=document.getElementById("account-clear-list"),accountChangePfp=document.getElementById("account-change-pfp"),prefCover=document.getElementById("pref-cover"),pfpModal=document.getElementById("pfp-modal"),pfpGrid=document.getElementById("pfp-grid"),pfpRegenerate=document.getElementById("pfp-regenerate"),pfpConfirm=document.getElementById("pfp-confirm"),pfpCancel=document.getElementById("pfp-cancel");let pfpGenNonce=0,pfpGenerating=!1,pfpSelectedSeed=null,pfpLastRegenAt=0;const modal=document.getElementById("modal"),mTitle=document.getElementById("modal-title"),fTitle=document.getElementById("f-title"),fKind=document.getElementById("f-kind"),fStatus=document.getElementById("f-status"),fSeason=document.getElementById("f-season"),fEpisode=document.getElementById("f-episode"),fImage=document.getElementById("f-image"),fNotes=document.getElementById("f-notes"),fCoverSource=document.getElementById("f-cover-source"),btnSave=document.getElementById("btn-save"),btnCancel=document.getElementById("btn-cancel"),btnDelete=document.getElementById("btn-delete"),btnAutoCover=document.getElementById("btn-autocover"),seasonDec=document.getElementById("season-dec"),seasonInc=document.getElementById("season-inc"),episodeDec=document.getElementById("episode-dec"),episodeInc=document.getElementById("episode-inc"),authModal=document.getElementById("auth-modal"),tabSignin=document.getElementById("tab-signin"),tabSignup=document.getElementById("tab-signup"),signinForm=document.getElementById("signin-form"),signupForm=document.getElementById("signup-form"),loginIdentifier=document.getElementById("login-identifier"),loginPassword=document.getElementById("login-password"),loginSend=document.getElementById("login-send"),signupUsername=document.getElementById("signup-username"),signupEmail=document.getElementById("signup-email"),signupPassword=document.getElementById("signup-password"),signupSend=document.getElementById("signup-send"),authClose=document.getElementById("auth-close"),authClose2=document.getElementById("auth-close-2"),forgotPasswordLink=document.getElementById("forgot-password"),resendConfirmationLink=document.getElementById("resend-confirmation"),verifyModal=document.getElementById("verify-modal"),verifyReload=document.getElementById("verify-reload"),offlineModal=document.getElementById("offline-modal"),confirmModal=document.getElementById("confirm-modal"),confirmTitle=document.getElementById("confirm-title"),confirmMsg=document.getElementById("confirm-msg"),confirmOk=document.getElementById("confirm-ok"),confirmCancel=document.getElementById("confirm-cancel"),importModal=document.getElementById("import-modal"),importPicker=document.getElementById("import-picker"),importFormat=document.getElementById("import-format"),importBrowse=document.getElementById("import-browse"),importFileName=document.getElementById("import-file-name"),importRun=document.getElementById("import-run"),importCancel=document.getElementById("import-cancel"),chatModal=document.getElementById("chat-modal"),chatMessagesEl=document.getElementById("chat-messages"),chatListEl=document.getElementById("chat-list"),chatEndEl=document.getElementById("chat-end"),chatInput=document.getElementById("chat-input"),chatSend=document.getElementById("chat-send"),chatClose=document.getElementById("chat-close"),chatPresenceText=document.getElementById("chat-presence-text"),chatSelfAvatar=document.getElementById("chat-self-avatar"),chatLoading=document.getElementById("chat-loading"),chatTypingEl=document.getElementById("chat-typing"),chatBottomFab=document.getElementById("chat-bottom-fab"),toasts=document.getElementById("toasts");let activeToast=null;const clearTitle=document.getElementById("clear-title"),clearImage=document.getElementById("clear-image"),clearNotes=document.getElementById("clear-notes"),scrollToTop=document.getElementById("scroll-to-top"),appPreloader=document.getElementById("app-preloader"),preloaderMsg=document.getElementById("preloader-msg"),sleep=e=>new Promise((t=>setTimeout(t,e)));function escapeHtml(e){return String(e).replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])))}const SAFE_BASE_DOMAINS=new Set(["youtube.com","youtu.be","x.com","twitter.com","discord.com","discord.gg","instagram.com","tiktok.com","reddit.com","twitch.tv","facebook.com","fb.com","github.com","gitlab.com","linkedin.com","snapchat.com","threads.net","pinterest.com"]);function isSafeLink(e){try{const t=new URL(e);if(!["http:","https:"].includes(t.protocol))return!1;const n=t.hostname.toLowerCase();for(const e of SAFE_BASE_DOMAINS)if(n===e||n.endsWith("."+e))return!0;return!1}catch{return!1}}function linkifySafe(e){return escapeHtml(e).replace(/(https?:\/\/[^\s<]+)/g,(e=>isSafeLink(e)?`<a href="${e}" target="_blank" rel="noopener noreferrer">${e}</a>`:e))}function showToast(e,t,n=2e3){activeToast&&activeToast.remove();const a=document.createElement("div");a.className="toast "+(e||"info");const o="success"===e?"fa-circle-check":"error"===e?"fa-triangle-exclamation":"fa-circle-info";a.innerHTML=`<i class="fa-solid ${o}"></i><div class="msg">${escapeHtml(t)}</div>`,toasts.appendChild(a),activeToast=a,requestAnimationFrame((()=>a.classList.add("enter")));const s=Math.max(1200,n);return setTimeout((()=>{a.classList.remove("enter"),a.classList.add("exit")}),s),setTimeout((()=>{activeToast===a&&(activeToast=null),a.remove()}),s+320),a}function showLoading(e=!0){loadingSpinner.classList.toggle("active",e)}function showPreloader(e=""){e&&(preloaderMsg.textContent=e),appPreloader.classList.add("active"),appPreloader.setAttribute("aria-hidden","false")}function updatePreloader(e=""){e&&(preloaderMsg.textContent=e)}function hidePreloader(){appPreloader.classList.remove("active"),appPreloader.setAttribute("aria-hidden","true")}function pad2(e){return String(e).padStart(2,"0")}function fmtTime(e){const t=new Date(e);return`${pad2(t.getHours())}:${pad2(t.getMinutes())} ${pad2(t.getDate())}/${pad2(t.getMonth()+1)}`}function getUsername(){const e=profile?.username?String(profile.username):"",t=user?.user_metadata?.username?String(user.user_metadata.username):"",n=user?.email?String(user.email).split("@")[0]:"";return(e||t||n||"bro").trim()||"bro"}function getAvatarSeed(){return(String(profile?.avatar_seed||"").trim()||getUsername()||"bro").trim()||"bro"}function diceAvatar(e){return`https://api.dicebear.com/7.x/bottts-neutral/svg?seed=${encodeURIComponent(e||"bro")}`}function userColor(e){const t=String(e||"bro");let n=0;for(let e=0;e<t.length;e++)n=(31*n+t.charCodeAt(e))%360;return`hsl(${n} 70% 65%)`}function setRandomBanner(){const e=Math.floor(10*Math.random())+1;bannerImage.style.backgroundImage=`url('assets/banner-${e}.png')`,bannerImage.style.opacity="1"}function initials(e){return String(e).trim().toUpperCase().split(/\s+/).slice(0,2).map((e=>e[0])).join("")}function progressText(e){const t=Number(e?.episode??0)||0,n=null!=e?.season?Number(e.season):null;return null!=n&&0!==n?`S${n} EP ${t}`:`EP ${t}`}function chipEl(e){const t=document.createElement("span");return t.className="chip",t.textContent=e,t}function isAuthRelatedError(e){const t=String(e?.message||"").toLowerCase(),n=e?.status||e?.code;return 401===n||403===n||t.includes("jwt")||t.includes("token")||t.includes("auth")||t.includes("session")}function isAbortError(e){return String(e?.name||"").toLowerCase().includes("abort")}async function withTimeout(e,t,n="Timed out"){let a=null;const o=new Promise(((e,o)=>{a=setTimeout((()=>o(new Error(n))),t)}));try{return await Promise.race([e,o])}finally{a&&clearTimeout(a)}}async function ensureFreshSession({force:e=!1,reason:t=""}={}){if(sessionRefreshInFlight)return sessionRefreshInFlight;const n=Date.now();return!e&&n-lastSessionRefreshAt<4e3?void 0:(sessionRefreshInFlight=(async()=>{try{const t=await withTimeout(supabase.auth.getSession(),2500,"Session check timed out"),n=t?.data?.session??null;n&&(session=n,user=n.user??null);const a=n?.expires_at?1e3*n.expires_at:null,o=!!a&&a-Date.now()<9e4;if(e||o){const e=await withTimeout(supabase.auth.refreshSession(),4e3,"Token refresh timed out"),t=e?.data?.session??null;t&&(session=t,user=t.user??null)}}catch(e){console.warn("ensureFreshSession:",t,e)}finally{lastSessionRefreshAt=Date.now(),sessionRefreshInFlight=null}})(),sessionRefreshInFlight)}function makeAbort(e){const t=new AbortController,n=setTimeout((()=>t.abort()),e);return{ctrl:t,timer:n}}async function sbExec(e,{timeoutMs:t=1e4,retryAuth:n=!0}={}){const a=async()=>{const{ctrl:n,timer:a}=makeAbort(t);try{const{data:t,error:a}=await e().abortSignal(n.signal);if(a)throw a;return t}finally{clearTimeout(a)}};try{return await a()}catch(e){if(n&&isAuthRelatedError(e))return await ensureFreshSession({force:!0,reason:"sbExec auth retry"}),await a();throw e}}function readURL(){const e=new URLSearchParams(window.location.search),t=e.get("tab"),n=TABS.find((e=>e.id===t));activeTab=n?n.id:"ALL";const a=e.get("q")||"";q=a.trim().toLowerCase(),searchEl.value=a;const o=e.get("view");viewMode="compact"===o||"grid"===o?o:"grid";const s=e.get("sort");sortMode=SORTS.includes(s)?s:"recent";return{chatFlag:"1"===e.get("chat")}}function updateURL(){const e=new URLSearchParams(window.location.search);e.set("tab",activeTab),e.set("view",viewMode),e.set("sort",sortMode),q?e.set("q",q):e.delete("q"),chatModal.classList.contains("open")?e.set("chat","1"):e.delete("chat");const t=e.toString();history.replaceState(null,"",`${location.pathname}${t?"?"+t:""}`)}function applyProfilePrefsAsDefaults(){if(!profile)return;const e=new URLSearchParams(window.location.search);let t=!1;const n=String(profile.ui_tab||"").trim(),a=String(profile.ui_view||"").trim(),o=String(profile.ui_sort||"").trim();!e.get("tab")&&TABS.some((e=>e.id===n))&&(activeTab=n,t=!0),!e.get("view")&&VIEWS.includes(a)&&(viewMode=a,t=!0),!e.get("sort")&&SORTS.includes(o)&&(sortMode=o,t=!0),t&&updateURL()}function scheduleUiPrefsSave(){if(!user)return;if(!profile)return;const e={ui_tab:activeTab,ui_view:viewMode,ui_sort:sortMode};lastSavedUiPrefs&&lastSavedUiPrefs.ui_tab===e.ui_tab&&lastSavedUiPrefs.ui_view===e.ui_view&&lastSavedUiPrefs.ui_sort===e.ui_sort||(uiPrefsSaveTimer&&clearTimeout(uiPrefsSaveTimer),uiPrefsSaveTimer=setTimeout((async()=>{try{await sbExec((()=>supabase.from("profiles").update(e).eq("id",user.id)),{timeoutMs:8e3,retryAuth:!0}),lastSavedUiPrefs=e}catch(e){console.warn("Failed to save UI prefs:",e?.message||e)}}),600))}let lastFocused=null;function isStaticModal(e){return"true"===e?.dataset?.static}function trapFocus(e){lastFocused=document.activeElement;const t=e.querySelectorAll("button, a, input, select, textarea");t[0]&&t[0].focus(),document.addEventListener("keydown",onKeyDownModal,!0)}function releaseFocus(){document.removeEventListener("keydown",onKeyDownModal,!0),lastFocused&&lastFocused.focus()}function openModal(e){e.classList.add("open"),e.setAttribute("aria-hidden","false"),trapFocus(e)}function closeModal(e){e.classList.remove("open"),e.setAttribute("aria-hidden","true"),e===confirmModal&&(confirmCallback=null),document.querySelector(".modal.open")||releaseFocus()}function onKeyDownModal(e){if("/"===e.key)return chatModal.classList.contains("open")?(e.preventDefault(),e.stopPropagation(),closeChat(),void setTimeout((()=>searchEl.focus()),0)):void e.stopPropagation();if("Escape"===e.key){const e=[...document.querySelectorAll(".modal.open")];if(e.some(isStaticModal))return;e.forEach((e=>{e===chatModal?closeChat():closeModal(e)}))}}document.addEventListener("click",(e=>{if(document.querySelectorAll(".modal.open").forEach((t=>{if(e.target===t){if(isStaticModal(t))return;if(t===chatModal)return closeChat();closeModal(t)}})),mobileMenu.classList.contains("open")){mobileMenu.contains(e.target)||menuBtn.contains(e.target)||closeMenu()}if(accountPanel.classList.contains("open")){accountPanel.contains(e.target)||document.getElementById("btn-account")?.contains(e.target)||accountPanel.classList.remove("open")}})),document.addEventListener("keydown",(e=>{document.querySelector(".modal.open")||"/"===e.key&&(e.preventDefault(),searchEl.focus())}));let confirmCallback=null;function openConfirm(e,t,n){confirmTitle.innerHTML=`<i class="fa-solid fa-triangle-exclamation"></i> ${escapeHtml(e||"Confirm")}`,confirmMsg.textContent=t||"Are you sure?",confirmCallback=n,openModal(confirmModal)}function setFloatGroupState(e){const t=e.querySelector("input, textarea, select");if(!t)return;const n=String(t.value??"").trim();e.classList.toggle("filled",""!==n)}function initFloatingLabels(e=document){e.querySelectorAll(".float-group").forEach((e=>{const t=e.querySelector("input, textarea, select");if(!t)return;const n=()=>setFloatGroupState(e);t.addEventListener("input",n),t.addEventListener("change",n),t.addEventListener("blur",n),t.addEventListener("focus",(()=>e.classList.add("filled"))),n()}))}function clampNonNegativeInt(e){const t=Number(e);return Number.isFinite(t)?Math.max(0,Math.trunc(t)):null}function updateStepperButtons(){const e=clampNonNegativeInt(fSeason.value),t=clampNonNegativeInt(fEpisode.value);seasonDec.disabled=!e||e<=0,episodeDec.disabled=!t||t<=0}function stepInput(e,t){const n=clampNonNegativeInt(e.value),a=Math.max(0,(n??0)+t);e.value=String(a),initFloatingLabels(modal),updateStepperButtons()}function countBadge(e){return"ALL"===e?data.length:"COMPLETED_SERIES"===e?data.filter((e=>"COMPLETED"===e.status&&"SERIES"===e.kind)).length:"COMPLETED_MOVIES"===e?data.filter((e=>"COMPLETED"===e.status&&"MOVIE"===e.kind)).length:data.filter((t=>t.status===e)).length}function renderTabs(){tabsEl.innerHTML="",TABS.forEach((e=>{const t=document.createElement("button");t.className="tab"+(activeTab===e.id?" active":""),t.innerHTML=`${e.label} <span class="count">${countBadge(e.id)}</span>`,t.onclick=()=>{activeTab=e.id,updateURL(),scheduleUiPrefsSave(),render()},tabsEl.appendChild(t)}))}function displayTitle(e){const t=null!=e?.title?String(e.title).trim():"";return t||(String(e?.title_romaji||"").trim()||String(e?.title_english||"").trim()||String(e?.title_native||"").trim()||"")}function filteredRows(){let e=data.slice();return"ALL"!==activeTab&&(e="COMPLETED_SERIES"===activeTab?e.filter((e=>"COMPLETED"===e.status&&"SERIES"===e.kind)):"COMPLETED_MOVIES"===activeTab?e.filter((e=>"COMPLETED"===e.status&&"MOVIE"===e.kind)):e.filter((e=>e.status===activeTab))),q&&(e=e.filter((e=>displayTitle(e).toLowerCase().includes(q)))),"az"===sortMode?e.sort(((e,t)=>displayTitle(e).localeCompare(displayTitle(t)))):"za"===sortMode?e.sort(((e,t)=>displayTitle(t).localeCompare(displayTitle(e)))):e.sort(((e,t)=>t.created_at?.localeCompare?.(e.created_at)||0)),e}function titleNode(e){const t=document.createElement("div");return t.className="title",t.textContent=e,t}function enableLongPressNote(e,t){let n=null,a=!1,o=0,s=0;const i=()=>{n&&clearTimeout(n),n=null,a=!1};e.addEventListener("touchstart",(e=>{if(1!==e.touches?.length)return;if(e.target.closest("button"))return;const r=e.touches[0];o=r.clientX,s=r.clientY,a=!0,i(),n=setTimeout((()=>{t.classList.add("note-open"),setTimeout((()=>t.classList.remove("note-open")),2200)}),450)}),{passive:!0}),e.addEventListener("touchmove",(e=>{if(!a||!e.touches?.[0])return;const t=e.touches[0];(Math.abs(t.clientX-o)>10||Math.abs(t.clientY-s)>10)&&i()}),{passive:!0}),e.addEventListener("touchend",i,{passive:!0}),e.addEventListener("touchcancel",i,{passive:!0})}function maybeAttachNotes(e,t,n){const a=String(e?.notes||"").trim();if(!a)return;t.classList.add("has-note");const o=document.createElement("div");o.className="note-tooltip",o.textContent=a,n.appendChild(o),enableLongPressNote(n,t)}function makeGridCard(e){const t=document.createElement("div");t.className="col";const n=document.createElement("div");n.className="card";const a=document.createElement("div");a.className="cover";const o=document.createElement("div");o.className="cover-loader",o.innerHTML='<i class="fa-solid fa-spinner"></i>';const s=e.image_url||"",i=document.createElement("img");i.alt=`Cover for ${displayTitle(e)||"anime"}`,i.loading="lazy";const r=document.createElement("div");r.className="ph",r.textContent=initials(displayTitle(e)||""),r.style.display=s?"none":"flex",s&&(i.src=s),i.onload=()=>{o.remove(),r.style.display="none"},i.onerror=()=>{r.style.display="flex",o.remove(),i.remove()},a.append(r,o),s&&a.appendChild(i);const l=document.createElement("div");l.className="floating-actions";const c=document.createElement("button");c.className="icon-btn",c.title="Edit",c.setAttribute("aria-label","Edit entry"),c.innerHTML='<i class="fa-solid fa-gear"></i>',c.onclick=()=>openModalFor(e),l.append(c),a.appendChild(l);const d=document.createElement("div");d.className="badge-bottom",d.innerHTML=`<i class="fa-solid fa-film"></i> ${progressText(e)}`,a.appendChild(d),maybeAttachNotes(e,n,a);const u=document.createElement("div");u.className="card-body";const m=document.createElement("div");m.className="title-row",m.append(titleNode(displayTitle(e)));const p=document.createElement("div");p.className="chips",p.appendChild(chipEl("MOVIE"===e.kind?"Movie":"Series")),p.appendChild(chipEl(progressText(e)));const f=buildControls(e);return u.append(m,p,f),n.append(a,u),t.appendChild(n),t}function makeCompactCard(e){const t=document.createElement("div");t.className="col";const n=document.createElement("div");n.className="card row";const a=document.createElement("div");a.className="cover";const o=document.createElement("div");o.className="cover-loader",o.innerHTML='<i class="fa-solid fa-spinner"></i>';const s=e.image_url||"",i=document.createElement("img");i.alt=`Thumbnail for ${displayTitle(e)||"anime"}`,i.loading="lazy";const r=document.createElement("div");r.className="ph",r.textContent=initials(displayTitle(e)||""),r.style.display=s?"none":"flex",s&&(i.src=s),i.onload=()=>{o.remove(),r.style.display="none"},i.onerror=()=>{r.style.display="flex",o.remove(),i.remove()},a.append(r,o),s&&a.appendChild(i),maybeAttachNotes(e,n,a);const l=document.createElement("div");l.className="floating-actions";const c=document.createElement("button");c.className="icon-btn",c.title="Edit",c.setAttribute("aria-label","Edit entry"),c.innerHTML='<i class="fa-solid fa-gear"></i>',c.onclick=()=>openModalFor(e),l.append(c);const d=document.createElement("div");d.className="card-body";const u=document.createElement("div");u.className="title-row",u.append(titleNode(displayTitle(e)));const m=document.createElement("div");m.className="chips",m.append(chipEl("MOVIE"===e.kind?"Movie":"Series"),chipEl(progressText(e)));const p=buildControls(e);return d.append(u,m,p),n.append(a,d,l),t.appendChild(n),t}function queueEntryPatch(e,t,{debounceMs:n=350}={}){if(!user||!e)return;const a=data.findIndex((t=>t.id===e));a>=0&&(data[a]={...data[a],...t}),entrySyncing.add(e),render();const o=entryPending.get(e)||{patch:{},timer:null,inFlight:!1,needsFlush:!1,tries:0};o.patch={...o.patch,...t},o.needsFlush=!0,o.timer&&clearTimeout(o.timer),o.timer=setTimeout((()=>flushEntryPatch(e)),n),entryPending.set(e,o)}async function flushEntryPatch(e){const t=entryPending.get(e);if(!t)return;if(t.inFlight)return t.needsFlush=!0,void entryPending.set(e,t);if(!t.needsFlush)return;t.inFlight=!0,t.needsFlush=!1,t.timer&&clearTimeout(t.timer),t.timer=null;const n={...t.patch};t.patch={},entryPending.set(e,t);try{await sbExec((()=>supabase.from("entries").update(n).eq("id",e)),{timeoutMs:9e3,retryAuth:!0}),t.tries=0;t.needsFlush||Object.keys(t.patch).length>0||entrySyncing.delete(e)}catch(a){console.warn("Entry sync failed:",a?.message||a),t.patch={...n,...t.patch},t.tries=(t.tries||0)+1;const o=Math.min(1e4,900*t.tries);t.timer&&clearTimeout(t.timer),t.timer=setTimeout((()=>flushEntryPatch(e)),o),entrySyncing.add(e),1===t.tries&&(isAbortError(a)?showToast("info","Sync timed out — retrying…",1600):isAuthRelatedError(a)?showToast("info","Session refreshed — retrying sync…",1600):showToast("info","Sync hiccup — retrying…",1600))}finally{t.inFlight=!1,entryPending.set(e,t);(t.needsFlush||Object.keys(t.patch).length>0)&&!t.timer&&(t.timer=setTimeout((()=>flushEntryPatch(e)),180),entryPending.set(e,t)),render()}}function buildControls(e){const t=document.createElement("div");t.className="controls";const n=document.createElement("button");n.className="control-btn",n.title="-1 episode",n.setAttribute("aria-label","Decrease episode"),n.innerHTML='<i class="fa-solid fa-minus"></i>';const a=Math.max(0,Number(e.episode??0)||0);n.disabled=a<=0,n.onclick=t=>adjustEpisode(e,t.shiftKey?-5:-1);const o=document.createElement("div");o.className="progress-readout";const s=entrySyncing.has(e.id);o.innerHTML=s?`<i class="fa-solid fa-spinner spin"></i> <span>${progressText(e)}</span>`:`<i class="fa-solid fa-tv"></i> <span>${progressText(e)}</span>`;const i=document.createElement("button");i.className="control-btn",i.title="+1 episode",i.setAttribute("aria-label","Increase episode"),i.innerHTML='<i class="fa-solid fa-plus"></i>',i.onclick=t=>adjustEpisode(e,t.shiftKey?5:1);const r=document.createElement("select");return r.className="move-select",r.setAttribute("aria-label","Move to list"),r.innerHTML=STATUSES.map((t=>`<option ${e.status===t?"selected":""}>${t}</option>`)).join(""),r.onchange=async t=>{const n=t.target.value;queueEntryPatch(e.id,{status:n},{debounceMs:250}),showToast("success","Moved to "+n)},t.append(n,o,i,r),t}function renderSkeletons(e=6){gridEl.innerHTML="",sectionsEl.innerHTML="";const t="compact"===viewMode?"grid view-compact":"grid view-grid";gridEl.className=t;for(let t=0;t<e;t++){const e=document.createElement("div");e.className="col";const t=document.createElement("div");t.className="skeleton-card";const n=document.createElement("div");n.className="skeleton-cover";const a=document.createElement("div");a.className="skeleton-body";const o=document.createElement("div");o.className="skeleton-title";const s=document.createElement("div");s.className="skeleton-chip";const i=document.createElement("div");i.className="skeleton-controls";for(let e=0;e<3;e++){const e=document.createElement("div");e.className="skeleton-btn",i.appendChild(e)}a.append(o,s,i),t.append(n,a),e.append(t),gridEl.append(e)}}confirmOk.onclick=async()=>{const e=confirmCallback;if(confirmCallback=null,closeModal(confirmModal),e)try{await e()}catch(e){console.error(e),showToast("error",e.message||"Error")}},confirmCancel.onclick=()=>{confirmCallback=null,closeModal(confirmModal)},seasonDec.onclick=()=>stepInput(fSeason,-1),seasonInc.onclick=()=>stepInput(fSeason,1),episodeDec.onclick=()=>stepInput(fEpisode,-1),episodeInc.onclick=()=>stepInput(fEpisode,1),[fSeason,fEpisode].forEach((e=>{e.addEventListener("input",(()=>{updateStepperButtons(),initFloatingLabels(modal)}))}));let renderDebounce=null;function render(){renderDebounce&&clearTimeout(renderDebounce),renderDebounce=setTimeout((()=>{if(renderTabs(),sectionsEl.innerHTML="",gridEl.innerHTML="",noResultsEl.classList.add("hidden"),!user)return emptyEl.style.display="",void updateAccountUI();emptyEl.style.display="none";const e=!!q,t="compact"===viewMode?makeCompactCard:makeGridCard,n="compact"===viewMode?"grid view-compact":"grid view-grid";let a=!1;if("ALL"===activeTab){[{id:"WATCHING",label:"Watching",icon:"fa-eye"},{id:"PLAN",label:"Plan to watch",icon:"fa-list-check"},{id:"REWATCH",label:"Rewatch",icon:"fa-rotate-left"},{id:"WAITING",label:"Waiting",icon:"fa-hourglass-half"},{id:"COMPLETED",label:"Completed",icon:"fa-check-double"}].forEach((e=>{let o=data.filter((t=>t.status===e.id));if(q&&(o=o.filter((e=>displayTitle(e).toLowerCase().includes(q)))),"az"===sortMode?o.sort(((e,t)=>displayTitle(e).localeCompare(displayTitle(t)))):"za"===sortMode?o.sort(((e,t)=>displayTitle(t).localeCompare(displayTitle(e)))):o.sort(((e,t)=>t.created_at?.localeCompare?.(e.created_at)||0)),!o.length)return;const s=document.createElement("div");s.className="section";const i=document.createElement("div");i.className="section-title",i.innerHTML=`<i class="fa-solid ${e.icon}"></i> ${e.label} <span class="muted-small">(${o.length})</span>`,s.appendChild(i);const r=document.createElement("div");r.className=n,o.forEach((e=>r.appendChild(t(e)))),s.appendChild(r),sectionsEl.appendChild(s);const l=document.createElement("hr");l.className="section-divider",sectionsEl.appendChild(l),a=!0}))}else{gridEl.className=n;const e=filteredRows();e.forEach((e=>gridEl.appendChild(t(e)))),a=e.length>0}!a&&user&&e&&noResultsEl.classList.remove("hidden"),updateViewToggleUI(),updateSortToggleUI(),updateMobileMenuUI(),updateAccountUI()}),70)}function adjustEpisode(e,t){const n=Math.max(0,Number(e.episode??0)||0),a=Math.max(0,n+t);queueEntryPatch(e.id,{episode:a},{debounceMs:380}),showToast("success",`${t>0?`+${t}`:t} EP`)}function updateAuthUI(){authCta.innerHTML="";const e=document.createElement("button");if(e.className="btn ghost",e.id="btn-chat",e.innerHTML='<i class="fa-solid fa-comments"></i> Chat',e.onclick=()=>openChatFromClick(),authCta.append(e),user){const e=document.createElement("button");e.className="btn ghost",e.id="btn-account",e.innerHTML='<i class="fa-solid fa-user"></i> Account',e.onclick=()=>accountPanel.classList.toggle("open"),authCta.append(e)}else{const e=document.createElement("button");e.className="btn ghost",e.innerHTML='<i class="fa-solid fa-right-to-bracket"></i> Sign in',e.onclick=()=>openModal(authModal),authCta.append(e)}updateMobileMenuUI(),updateAccountUI()}function updateAccountUI(){if(!user)return;const e=getUsername();accountUsername.textContent=e,accountEmail.textContent=user.email||"Unknown",accountTotal.textContent=data.length,accountWatching.textContent=data.filter((e=>"WATCHING"===e.status)).length,accountOnline.textContent=presenceCount,accountAvatar.textContent="",accountAvatar.style.backgroundImage=`url('${diceAvatar(getAvatarSeed())}')`,prefCover&&(prefCover.value=defaultCoverSource)}async function loadProfile(){if(!user)return;const{data:e,error:t}=await sbExec((()=>supabase.from("profiles").select("username,cover_source,avatar_seed,avatar_seed_history,ui_tab,ui_view,ui_sort").eq("id",user.id).single()),{timeoutMs:9e3,retryAuth:!0}).then((e=>({data:e,error:null}))).catch((e=>({data:null,error:e})));if(t)return console.warn("Profile load error:",t.message||t),void(profile=null);profile=e||null,defaultCoverSource=profile?.cover_source||"ANILIST",avatarSeedHistory=new Set(Array.isArray(profile?.avatar_seed_history)?profile.avatar_seed_history:[]),profile?.avatar_seed&&avatarSeedHistory.add(String(profile.avatar_seed)),applyProfilePrefsAsDefaults(),lastSavedUiPrefs={ui_tab:profile?.ui_tab||"ALL",ui_view:profile?.ui_view||"grid",ui_sort:profile?.ui_sort||"recent"}}let entriesLoading=!1;async function loadEntries({showSkeleton:e=!0,silent:t=!1,retryIfEmpty:n=!0}={}){if(!user)return;if(entriesLoading)return;entriesLoading=!0;const a=data.length>0;e&&!a&&renderSkeletons(8),!t&&appPreloader.classList.contains("active")&&updatePreloader("Loading your shelf…");try{let e=await sbExec((()=>supabase.from("entries").select("*").order("created_at",{ascending:!1})),{timeoutMs:12e3,retryAuth:!0});if(e=e||[],n&&!didEmptyEntriesRetryFix&&Array.isArray(e)&&0===e.length){didEmptyEntriesRetryFix=!0,await ensureFreshSession({force:!0,reason:"empty entries retry"});try{const t=await sbExec((()=>supabase.from("entries").select("*").order("created_at",{ascending:!1})),{timeoutMs:12e3,retryAuth:!1});Array.isArray(t)&&t.length>0&&(e=t)}catch{}}data=e,render(),enqueueMissingCovers(data)}catch(e){console.error(e),t||showToast("error",e.message||"Failed to load")}finally{entriesLoading=!1}}function setupRealtime(){changesChannel&&supabase.removeChannel(changesChannel),user&&(changesChannel=supabase.channel("entries-db").on("postgres_changes",{event:"*",schema:"public",table:"entries",filter:`user_id=eq.${user.id}`},(e=>{const{eventType:t,new:n,old:a}=e;if("INSERT"===t)data.some((e=>e.id===n.id))||data.unshift(n),enqueueMissingCovers([n]);else if("UPDATE"===t){const e=data.findIndex((e=>e.id===n.id));e>=0&&(data[e]=n)}else if("DELETE"===t){const e=data.findIndex((e=>e.id===a.id));e>=0&&data.splice(e,1)}render()})).subscribe())}function setupPresence(){presenceChannel&&supabase.removeChannel(presenceChannel);const e=user?.id||`anon_${Math.random().toString(36).slice(2)}`;presenceChannel=supabase.channel("room:lobby",{config:{presence:{key:e}}}),presenceChannel.on("presence",{event:"sync"},(()=>{const e=presenceChannel.presenceState(),t=new Set;Object.values(e).forEach((e=>e.forEach((e=>t.add(e.presence_ref))))),presenceCount=t.size,chatPresenceText.textContent=`${presenceCount} online`,mChatOnline.textContent=`(${presenceCount} online)`,updateAccountUI()})),presenceChannel.subscribe((async e=>{"SUBSCRIBED"===e&&await presenceChannel.track({at:Date.now()})}))}function openModalFor(e){editingId=e?.id||null,mTitle.innerHTML='<i class="fa-solid fa-pen-to-square"></i> '+(editingId?"Edit item":"Add item"),fTitle.value=displayTitle(e||{})||"",fKind.value=e?.kind||"SERIES",fStatus.value=e?.status||"PLAN",fSeason.value=e?.season??"",fEpisode.value=e?.episode??"",fImage.value=e?.image_url||"",fNotes.value=e?.notes||"",fCoverSource.value=e?.cover_source||"",btnDelete.style.display=editingId?"":"none",openModal(modal),fTitle.focus(),toggleClearButtons(),initFloatingLabels(modal),updateStepperButtons()}async function saveModal(){if(!user)return showToast("error","Sign in first");const e=(fTitle.value||"").trim(),t=String(fKind.value||"").trim(),n=String(fStatus.value||"").trim();if(!e)return showToast("error","Title required");if(!t)return showToast("error","Series/Movie required");if(!n)return showToast("error","Category required");const a={title:e,kind:t,status:n,season:""!==fSeason.value?clampNonNegativeInt(fSeason.value):null,episode:""!==fEpisode.value?clampNonNegativeInt(fEpisode.value):null,image_url:fImage.value.trim()||null,notes:fNotes.value.trim()||null,cover_source:fCoverSource.value||null,user_id:user.id};btnSave.classList.add("loading"),btnSave.innerHTML="Save";try{if(editingId){const e=await sbExec((()=>supabase.from("entries").update(a).eq("id",editingId).select().single()),{timeoutMs:12e3,retryAuth:!0}),t=data.findIndex((e=>e.id===editingId));t>=0&&(data[t]=e),showToast("success","Saved")}else{const e=await sbExec((()=>supabase.from("entries").insert(a).select().single()),{timeoutMs:12e3,retryAuth:!0});data.some((t=>t.id===e.id))||data.unshift(e),showToast("success","Added"),enqueueMissingCovers([e])}render(),closeModal(modal)}catch(e){console.error(e),isAbortError(e)?showToast("error","Save timed out — try again"):showToast("error",e.message||"Failed to save")}finally{btnSave.classList.remove("loading"),btnSave.innerHTML='<i class="fa-solid fa-floppy-disk"></i>Save'}}async function removeModal(){editingId&&openConfirm("Delete item","Delete this anime from your shelf?",(async()=>{const e=editingId;await sbExec((()=>supabase.from("entries").delete().eq("id",e)),{timeoutMs:1e4,retryAuth:!0});const t=data.findIndex((t=>t.id===e));t>=0&&data.splice(t,1),showToast("success","Deleted"),render(),closeModal(modal)}))}function toggleClearButtons(){const e=(e,t)=>e.classList.toggle("visible",""!==String(t.value??"").trim());e(clearTitle,fTitle),e(clearImage,fImage),e(clearNotes,fNotes),searchClear.classList.toggle("visible",""!==searchEl.value.trim()),initFloatingLabels(modal)}btnAdd.onclick=()=>openModalFor(),btnCancel.onclick=()=>closeModal(modal),btnSave.onclick=saveModal,btnDelete.onclick=removeModal,[fTitle,fImage,fNotes].forEach((e=>e.addEventListener("input",toggleClearButtons))),clearTitle.onclick=()=>{fTitle.value="",toggleClearButtons(),fTitle.focus()},clearImage.onclick=()=>{fImage.value="",toggleClearButtons(),fImage.focus()},clearNotes.onclick=()=>{fNotes.value="",toggleClearButtons(),fNotes.focus()};let searchTimer=null;function doExport(){const e=data.map((({id:e,user_id:t,created_at:n,updated_at:a,...o})=>o)),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),a=document.createElement("a");a.href=n,a.download="animehlist-export.json",a.click(),URL.revokeObjectURL(n),showToast("success","Exported")}async function importFromFile(e,t){if(!user)throw new Error("Sign in first");showLoading(!0);try{const n=await parseImport(e,t);if(!Array.isArray(n))throw new Error("Invalid import: expected an array of entries");const a=n.map(normalizeImport).filter((e=>e.title&&e.title.trim().length>0)).map((e=>({...e,user_id:user.id})));if(!a.length)return void showToast("error","No valid entries found in file");const o=await sbExec((()=>supabase.from("entries").insert(a).select()),{timeoutMs:2e4,retryAuth:!0});for(const e of o||[])data.some((t=>t.id===e.id))||data.unshift(e);render(),enqueueMissingCovers(o||[]),showToast("success",`Imported ${o?.length||0} items`)}finally{showLoading(!1)}}async function parseImport(e,t){if("MAL"===t){return normalizeMAL(await e.text())}if("ANILIST"===t){return normalizeAniList(await e.text())}const n=await e.text(),a=JSON.parse(n);if(!Array.isArray(a))throw new Error("Invalid JSON: expected an array");return a}function normalizeImport(e){const t=String(e.title||"").trim(),n="MOVIE"===String(e.kind||"SERIES").toUpperCase()?"MOVIE":"SERIES";let a=String(e.status||"PLAN").toUpperCase();STATUSES.includes(a)||(a="PLAN");const o=""===e.season||null==e.season?null:clampNonNegativeInt(e.season),s=""===e.episode||null==e.episode?null:clampNonNegativeInt(e.episode),i=String(e.notes||"").trim()||null;let r=String(e.image_url||"").trim()||null;r&&r.startsWith("file://")&&(r=null);const l=String(e.title_romaji||"").trim()||null,c=String(e.title_english||"").trim()||null,d=String(e.title_native||"").trim()||null,u=Number.isFinite(Number(e.anilist_id))?Number(e.anilist_id):null,m=e.cover_source?String(e.cover_source).toUpperCase():null;return{title:t,kind:n,status:a,season:o,episode:s,notes:i,image_url:r,title_romaji:l,title_english:c,title_native:d,anilist_id:u,cover_source:m&&["ANILIST","JIKAN","KITSU"].includes(m)?m:null}}function normalizeMAL(e){const t=[...(new DOMParser).parseFromString(e,"application/xml").querySelectorAll("anime")];return t.map((e=>{var t;var n;return{title:String(e.querySelector("series_title")?.textContent||"").trim(),status:(t=e.querySelector("my_status")?.textContent,(t=String(t||"").toLowerCase()).includes("watching")?"WATCHING":t.includes("plan")?"PLAN":t.includes("completed")?"COMPLETED":t.includes("on-hold")?"WAITING":(t.includes("dropped"),"PLAN")),kind:(n=e.querySelector("series_type")?.textContent,3===Number(n||1)?"MOVIE":"SERIES"),episode:Number(e.querySelector("my_watched_episodes")?.textContent||0)||null}}))}function normalizeAniList(e){let t;try{t=JSON.parse(e)}catch{throw new Error("Invalid JSON")}const n=t?.data?.MediaListCollection?.lists||t?.MediaListCollection?.lists||t?.lists||null,a={CURRENT:"WATCHING",PLANNING:"PLAN",COMPLETED:"COMPLETED",PAUSED:"WAITING",DROPPED:"PLAN",REPEATING:"REWATCH"},o=[];if(Array.isArray(n)){for(const e of n)for(const t of e.entries||[]){const e=t.media||{},n=e.title?.romaji||e.title?.english||e.title?.native||t.notes||"",s="MOVIE"===e.format?"MOVIE":"SERIES",i=a[t.status]||"PLAN",r=Number(t.progress||0)||null;o.push({title:n,status:i,kind:s,episode:r,title_romaji:e.title?.romaji||null,title_english:e.title?.english||null,title_native:e.title?.native||null,anilist_id:e.id||null})}return o}if(Array.isArray(t))return t;if(Array.isArray(t?.entries))return t.entries;throw new Error("Unrecognized AniList export shape")}function openMenu(){mobileMenu.classList.add("open"),menuBtn.setAttribute("aria-expanded","true")}function closeMenu(){mobileMenu.classList.remove("open"),menuBtn.setAttribute("aria-expanded","false")}function updateMobileMenuUI(){user?(mUserEmail.textContent=user.email||"user",mLogin.classList.add("hidden"),mLogout.classList.remove("hidden")):(mUserEmail.textContent="Signed out",mLogin.classList.remove("hidden"),mLogout.classList.add("hidden")),mChatOnline.textContent=`(${presenceCount} online)`}function updateViewToggleUI(){"grid"===viewMode?(viewBtnGrid.classList.add("active"),viewBtnGrid.setAttribute("aria-pressed","true"),viewBtnCompact.classList.remove("active"),viewBtnCompact.setAttribute("aria-pressed","false")):(viewBtnCompact.classList.add("active"),viewBtnCompact.setAttribute("aria-pressed","true"),viewBtnGrid.classList.remove("active"),viewBtnGrid.setAttribute("aria-pressed","false"))}function updateSortToggleUI(){sortToggle.querySelectorAll(".seg").forEach((e=>e.classList.toggle("active",e.dataset.sort===sortMode)))}function getPageScrollTop(){const e=document.scrollingElement;return e&&e.scrollTop||window.scrollY||document.documentElement.scrollTop||document.body.scrollTop||0}function scrollPageToTop(){const e={top:0,left:0,behavior:"smooth"},t=document.scrollingElement||document.documentElement;try{t.scrollTo(e)}catch{}try{window.scrollTo(e)}catch{}try{document.documentElement.scrollTo(e)}catch{}try{document.body.scrollTo(e)}catch{}}function scheduleScrollTopHide(){scrollTopInactivityTimer&&clearTimeout(scrollTopInactivityTimer),scrollTopInactivityTimer=setTimeout((()=>{scrollToTop.classList.remove("visible")}),3e3)}function refreshScrollTopVisibilityFromActivity(){getPageScrollTop()>200&&(scrollToTop.classList.add("visible"),scheduleScrollTopHide())}searchEl.oninput=()=>{clearTimeout(searchTimer),searchTimer=setTimeout((()=>{q=searchEl.value.trim().toLowerCase(),updateURL(),render(),searchClear.classList.toggle("visible",""!==searchEl.value.trim())}),120)},searchClear.onclick=()=>{searchEl.value="",q="",updateURL(),render(),searchClear.classList.remove("visible"),searchEl.focus()},noResultsNewBtn.addEventListener("click",(()=>{if(!user)return showToast("info","Sign in to add items"),void openModal(authModal);openModalFor()})),document.getElementById("btn-export").onclick=doExport,accountExport.onclick=doExport,document.getElementById("btn-import").onclick=()=>openModal(importModal),mImport.addEventListener("click",(()=>{closeMenu(),openModal(importModal)})),importCancel.onclick=()=>closeModal(importModal),importBrowse.onclick=()=>importPicker.click(),importPicker.addEventListener("change",(()=>{const e=importPicker.files?.[0];importFileName.textContent=e?e.name:"No file selected"})),importRun.onclick=()=>{const e=importPicker.files?.[0];if(!e)return showToast("error","Choose a file first");openConfirm("Import list","This will add items to your shelf. Continue?",(async()=>{await importFromFile(e,importFormat.value),importPicker.value="",importFileName.textContent="No file selected",closeModal(importModal)}))},menuBtn.addEventListener("click",(e=>{e.stopPropagation(),mobileMenu.classList.contains("open")?closeMenu():openMenu()})),mAdd.addEventListener("click",(()=>{closeMenu(),openModalFor()})),mViewGrid.addEventListener("click",(()=>{viewMode="grid",updateURL(),scheduleUiPrefsSave(),closeMenu(),render()})),mViewCompact.addEventListener("click",(()=>{viewMode="compact",updateURL(),scheduleUiPrefsSave(),closeMenu(),render()})),mLogin.addEventListener("click",(()=>{closeMenu(),openModal(authModal)})),mLogout.addEventListener("click",(()=>openConfirm("Sign out","Are you sure you want to sign out?",(async()=>{await supabase.auth.signOut(),location.reload()})))),mExport.addEventListener("click",(()=>{closeMenu(),doExport()})),mOpenChat.addEventListener("click",(()=>{closeMenu(),openChatFromClick()})),sortToggle.addEventListener("click",(e=>{const t=e.target.closest(".seg[data-sort]");t&&(sortMode=t.dataset.sort,updateURL(),scheduleUiPrefsSave(),updateSortToggleUI(),render())})),viewBtnGrid.addEventListener("click",(()=>{viewMode="grid",updateURL(),scheduleUiPrefsSave(),render()})),viewBtnCompact.addEventListener("click",(()=>{viewMode="compact",updateURL(),scheduleUiPrefsSave(),render()})),scrollToTop.onclick=()=>{scrollPageToTop()};const onAnyScroll=()=>{getPageScrollTop()>200?(scrollToTop.classList.add("visible"),scheduleScrollTopHide()):scrollToTop.classList.remove("visible")};function randomSeed(){return Math.random().toString(36).slice(2,10)+"_"+Math.random().toString(36).slice(2,10)+"_"+Date.now().toString(36)}function generateUniqueSeeds(e,t){const n=[];let a=0;for(;n.length<e&&a<5e3;){a++;const e=randomSeed();t.has(e)||(n.push(e),t.add(e))}return n}function renderPfpSkeletons(){pfpGrid.innerHTML="";for(let e=0;e<5;e++){const e=document.createElement("div");e.className="skeleton-card",e.innerHTML='\n            <div class="skeleton-cover"></div>\n            <div class="skeleton-body">\n              <div class="skeleton-title"></div>\n              <div class="skeleton-chip"></div>\n            </div>\n          ',pfpGrid.appendChild(e)}}function setPfpButtonsState(){pfpConfirm.disabled=!pfpSelectedSeed||pfpGenerating,pfpRegenerate.disabled=pfpGenerating}function renderPfpOptions(e,t){pfpGrid.innerHTML="",pfpSelectedSeed=null,setPfpButtonsState(),e.forEach(((e,n)=>{const a=document.createElement("button");a.type="button",a.className="pfp-card",a.setAttribute("aria-label","Avatar option "+(n+1));const o=document.createElement("div");o.className="pfp-cover";const s=document.createElement("img");s.alt="Avatar preview",s.loading="eager",s.decoding="async",s.src=diceAvatar(e);const i=document.createElement("div");i.className="pfp-load",i.innerHTML='<i class="fa-solid fa-spinner"></i>',s.onload=()=>{t===pfpGenNonce&&i.remove()},s.onerror=()=>{t===pfpGenNonce&&i.remove()},o.append(s,i);const r=document.createElement("div");r.className="pfp-meta",r.innerHTML=`<span>Variant</span><span>#${n+1}</span>`,a.append(o,r),a.onclick=()=>{[...pfpGrid.querySelectorAll(".pfp-card")].forEach((e=>e.classList.remove("selected"))),a.classList.add("selected"),pfpSelectedSeed=e,setPfpButtonsState()},pfpGrid.appendChild(a)}))}async function regeneratePfp(){if(!user)return showToast("error","Sign in first");if(pfpGenerating)return;const e=Date.now();if(!(e-pfpLastRegenAt<450)){pfpLastRegenAt=e,pfpGenerating=!0,pfpGenNonce++,setPfpButtonsState(),pfpRegenerate.classList.add("loading"),pfpRegenerate.innerHTML="Regenerate",renderPfpSkeletons();try{avatarSeedHistory.add(getAvatarSeed()),avatarSeedHistory.add(getUsername());renderPfpOptions(generateUniqueSeeds(5,avatarSeedHistory),pfpGenNonce);const e=[...avatarSeedHistory].slice(-120);await sbExec((()=>supabase.from("profiles").update({avatar_seed_history:e}).eq("id",user.id)),{timeoutMs:1e4,retryAuth:!0}),profile&&(profile.avatar_seed_history=e)}catch(e){console.warn(e),showToast("error",e.message||"Failed to regenerate")}finally{pfpGenerating=!1,pfpRegenerate.classList.remove("loading"),pfpRegenerate.innerHTML='<i class="fa-solid fa-arrows-rotate"></i>Regenerate',setPfpButtonsState()}}}function refreshChatMyAvatars(){if(!user)return;const e=diceAvatar(getAvatarSeed());document.querySelectorAll(".msg.mine .avatar").forEach((t=>{t&&"IMG"===t.tagName&&(t.src=e)}))}function normalizeStr(e){return String(e||"").toLowerCase().replace(/’|‘|“|”/g,'"').replace(/[^a-z0-9\s]/g," ").replace(/\s+/g," ").trim()}function tokenSet(e){return new Set(normalizeStr(e).split(" ").filter(Boolean).filter((e=>!["the","a","an","and","of"].includes(e))))}function jaccard(e,t){const n=tokenSet(e),a=tokenSet(t);if(!n.size||!a.size)return 0;let o=0;n.forEach((e=>a.has(e)&&o++));const s=n.size+a.size-o;return o/s}function scoreCandidate(e,t){const n=[t?.title?.romaji,t?.title?.english,t?.title?.native,...t?.synonyms||[]].filter(Boolean);let a=0;for(const t of n)a=Math.max(a,jaccard(e,t));const o=t?.popularity||0;return a+Math.min(.05,o/1e6*.05)}async function fetchWithTimeout(e,t={},n=9e3){const{ctrl:a,timer:o}=makeAbort(n);try{return await fetch(e,{...t,signal:a.signal})}finally{clearTimeout(o)}}async function fetchAniListMeta(e){const t=await fetchWithTimeout("https://graphql.anilist.co",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({query:"\n          query ($search: String) {\n            Page(perPage: 6) {\n              media(search: $search, type: ANIME) {\n                id\n                title { romaji english native }\n                synonyms\n                format\n                popularity\n                coverImage { large extraLarge color }\n              }\n            }\n          }\n        ",variables:{search:e}})},1e4);if(!t.ok)throw new Error("AniList search failed");const n=await t.json(),a=n?.data?.Page?.media||[];a.forEach((t=>t._score=scoreCandidate(e,t))),a.sort(((e,t)=>t._score-e._score));const o=a[0];return{image:o?.coverImage?.extraLarge||o?.coverImage?.large||null,titles:{romaji:o?.title?.romaji||null,english:o?.title?.english||null,native:o?.title?.native||null},anilist_id:o?.id||null}}async function fetchJikanCover(e){const t=`https://api.jikan.moe/v4/anime?q=${encodeURIComponent(e)}&limit=3&sfw`,n=await fetchWithTimeout(t,{},1e4);if(!n.ok)throw new Error("Jikan search failed");const a=await n.json(),o=(a?.data||[])[0];return{image:o?.images?.webp?.large_image_url||o?.images?.jpg?.large_image_url||o?.images?.webp?.image_url||null}}async function fetchKitsuCover(e){const t=`https://kitsu.io/api/edge/anime?filter[text]=${encodeURIComponent(e)}&page[limit]=3`,n=await fetchWithTimeout(t,{},1e4);if(!n.ok)throw new Error("Kitsu search failed");const a=await n.json(),o=(a?.data||[])[0];return{image:o?.attributes?.posterImage?.original||o?.attributes?.posterImage?.large||null||null}}function sourceOrder(e){return"JIKAN"===e?["JIKAN","ANILIST","KITSU"]:"KITSU"===e?["KITSU","ANILIST","JIKAN"]:["ANILIST","JIKAN","KITSU"]}async function autoFetchCover(e,t,n=!1){if(!e)return{image:null,titles:null,anilist_id:null};const a=t||"ANILIST",o=n?[a]:sourceOrder(a),s={image:null,titles:null,anilist_id:null};for(const t of o)try{if("ANILIST"===t){const t=await fetchAniListMeta(e);if(t.image){s.image=t.image,s.titles=t.titles,s.anilist_id=t.anilist_id;break}}else if("JIKAN"===t){const t=await fetchJikanCover(e);if(t.image){s.image=t.image;break}}else if("KITSU"===t){const t=await fetchKitsuCover(e);if(t.image){s.image=t.image;break}}}catch{}return s}function showCoverProgress(){coverProgressEl.classList.add("visible"),coverProgressEl.classList.remove("success"),coverProgressText.innerHTML=`<i class="fa-solid fa-spinner spin"></i> Fetching covers… <b id="cover-progress-count">${coverDone} / ${coverTotal}</b>`}function updateCoverProgress(){coverProgressEl.classList.contains("visible")||showCoverProgress();const e=coverProgressEl.querySelector("b");e&&(e.textContent=`${coverDone} / ${coverTotal}`)}function finishCoverProgress(){coverProgressEl.classList.add("success"),coverProgressText.innerHTML='<i class="fa-solid fa-circle-check"></i> Covers updated ✔',setTimeout((()=>{coverProgressEl.classList.remove("visible"),coverProgressEl.classList.remove("success")}),2e3)}function enqueueMissingCovers(e){const t=Array.isArray(e)?e:data;let n=0;for(const e of t)e?.id&&e?.title&&(e.image_url||coverAttemptedThisRun.has(e.id)||coverQueue.has(e.id)||(coverQueue.add(e.id),coverTotal++,n++));n>0&&(updateCoverProgress(),coverWorkerRunning||startCoverWorker())}async function processCoverRow(e){const t=e.cover_source||null,n=t||defaultCoverSource,a=!!t,o=await autoFetchCover(e.title,n,a);if(!o?.image&&!o?.titles)return;const s={};o.image&&(s.image_url=o.image),o.titles&&(s.title_romaji=o.titles.romaji||e.title_romaji||null,s.title_english=o.titles.english||e.title_english||null,s.title_native=o.titles.native||e.title_native||null,s.anilist_id=o.anilist_id||e.anilist_id||null),await sbExec((()=>supabase.from("entries").update(s).eq("id",e.id)),{timeoutMs:1e4,retryAuth:!0});const i=data.findIndex((t=>t.id===e.id));i>=0&&(data[i]={...data[i],...s}),render()}async function startCoverWorker(){if(coverWorkerRunning)return;coverWorkerRunning=!0,showCoverProgress();try{for(;coverQueue.size>0;){for(;coverWorkerActive<3&&coverQueue.size>0;){const e=coverQueue.values().next().value;coverQueue.delete(e);const t=data.find((t=>t.id===e));t&&(coverAttemptedThisRun.add(e),coverWorkerActive++,(async()=>{try{await processCoverRow(t)}catch{}finally{coverDone++,coverWorkerActive--,updateCoverProgress()}})())}await sleep(150)}for(;coverWorkerActive>0;)await sleep(150)}finally{coverWorkerRunning=!1,coverAttemptedThisRun.clear();const e=coverTotal,t=coverDone;coverTotal=0,coverDone=0,e>0&&t>0&&finishCoverProgress()}}function checkEmailVerifyLanding(){const e=new URL(window.location.href);"signup"===(e.searchParams.get("type")||(e.hash.includes("type=signup")?"signup":null))&&(openModal(verifyModal),e.searchParams.delete("type"),history.replaceState(null,"",e.pathname+(e.searchParams.toString()?"?"+e.searchParams.toString():"")))}function syncOfflineModal(){navigator.onLine?offlineModal.classList.contains("open")&&closeModal(offlineModal):openModal(offlineModal)}function updateSelfAvatar(){chatSelfAvatar.src=diceAvatar(getAvatarSeed())}function isNearChatBottom(){return chatMessagesEl.scrollHeight-chatMessagesEl.scrollTop-chatMessagesEl.clientHeight<140}function scrollChatToBottom({force:e=!1,smooth:t=!0}={}){if(!(e||isNearChatBottom()))return;requestAnimationFrame((()=>{try{chatMessagesEl.scrollTo({top:chatMessagesEl.scrollHeight,behavior:t?"smooth":"auto"})}catch{chatMessagesEl.scrollTop=chatMessagesEl.scrollHeight}chatBottomFab.classList.remove("visible")}))}async function loadChatHistory(e=3e3){chatLoading.classList.add("visible");try{const t=await sbExec((()=>supabase.from("chat_messages").select("id,user_id,username,content,created_at,is_system").order("created_at",{ascending:!0}).limit(e)),{timeoutMs:12e3,retryAuth:!0});chatListEl.innerHTML="",(t||[]).forEach(renderChatMessage),scrollChatToBottom({force:!0,smooth:!1})}catch(e){console.error(e),showToast("error",e.message||"Failed to load chat")}finally{chatLoading.classList.remove("visible")}}function renderChunkedMessageContent(e,t){const n=String(t||"").replace(/\r\n/g,"\n").split("\n"),a=[];for(let e=0;e<n.length;e+=5)a.push(n.slice(e,e+5).join("\n"));let o=0;const s=()=>{if(o>=a.length)return;const t=document.createElement("div");t.className="content-chunk enter",t.innerHTML=linkifySafe(a[o]),e.appendChild(t),requestAnimationFrame((()=>t.classList.add("active"))),o++,o<a.length&&i()},i=()=>{const t=e.querySelector(".chat-readmore");t&&t.remove();const n=document.createElement("button");n.type="button",n.className="text-link chat-readmore",n.textContent="...Read more",n.onclick=()=>{n.remove(),s()},e.appendChild(n)};s()}function renderChatMessage(e){const t=e.user_id===user?.id&&!e.is_system,n=!!e.is_system&&String(e.username||"").toLowerCase()===SUSIE_NAME.toLowerCase(),a=document.createElement("div");a.className="msg"+(t?" mine":"")+(n?" susie":"");const o=document.createElement("img");o.className="avatar",o.alt="",o.src=n?SUSIE_AVATAR:diceAvatar(t?getAvatarSeed():e.username||"bro");const s=document.createElement("div");s.className="bubble";const i=document.createElement("div");i.className="meta";const r=document.createElement("span");r.className="user",r.textContent=e.username||"bro",r.style.color=n?"var(--susie)":userColor(e.username);const l=document.createElement("span");l.className="time",l.textContent=fmtTime(e.created_at),i.append(r,l);const c=document.createElement("div");c.className="content",renderChunkedMessageContent(c,e.content||""),s.append(i,c),a.append(t?s:o,t?o:s),chatListEl.appendChild(a)}function setupChatRealtime(){chatChannel&&supabase.removeChannel(chatChannel),chatChannel=supabase.channel("realtime:public:chat_messages").on("postgres_changes",{event:"INSERT",schema:"public",table:"chat_messages"},(e=>{const t=isNearChatBottom();renderChatMessage(e.new),t?scrollChatToBottom({force:!0,smooth:!0}):chatBottomFab.classList.add("visible")})).subscribe()}function setupTyping(){typingChannel&&supabase.removeChannel(typingChannel),typingChannel=supabase.channel("room:chat-typing",{config:{broadcast:{ack:!1}}}),typingChannel.on("broadcast",{event:"typing"},(({payload:e})=>{if(!e?.user_id||e.user_id===user?.id)return;const t=String(e.username||"Someone");typingUsers.set(e.user_id,{username:t,until:Date.now()+1600}),scheduleTypingIndicatorUpdate()})).subscribe()}function pruneTypingUsers(){const e=Date.now();for(const[t,n]of typingUsers.entries())(!n||n.until<e)&&typingUsers.delete(t)}function scheduleTypingIndicatorUpdate(){typingUiDebounce&&clearTimeout(typingUiDebounce),typingUiDebounce=setTimeout((()=>{pruneTypingUsers();const e=typingUsers.size;if(e<=0)chatTypingEl.classList.remove("visible");else{if(1===e){const e=[...typingUsers.values()][0];chatTypingEl.textContent=`${e.username} is typing…`}else chatTypingEl.textContent=`${e} people are typing…`;chatTypingEl.classList.add("visible"),setTimeout((()=>scheduleTypingIndicatorUpdate()),900)}}),140)}function broadcastTypingDebounced(){if(!typingChannel||!user)return;const e=Date.now();if(e-typingLastBroadcastAt>=700)return typingLastBroadcastAt=e,void typingChannel.send({type:"broadcast",event:"typing",payload:{user_id:user.id,username:getUsername()}});typingBroadcastTimer&&clearTimeout(typingBroadcastTimer),typingBroadcastTimer=setTimeout((()=>{typingLastBroadcastAt=Date.now(),typingChannel.send({type:"broadcast",event:"typing",payload:{user_id:user.id,username:getUsername()}})}),700-(e-typingLastBroadcastAt))}function faNumberIconOrText(e){return`<span style="font-weight:900">${escapeHtml(String(e))}</span>`}function renderChatSendButton(){const e=Date.now(),t=Math.max(0,Math.ceil((chatCooldownUntil-e)/1e3));return chatSending?(chatSend.innerHTML='<i class="fa-solid fa-spinner spin"></i>',void(chatSend.disabled=!0)):t>0?(chatSend.innerHTML=faNumberIconOrText(t),void(chatSend.disabled=!0)):(chatSend.innerHTML='<i class="fa-solid fa-paper-plane"></i>',void(chatSend.disabled=!user||!(chatInput.value||"").trim()))}function startChatCooldown(e=5e3){chatCooldownUntil=Date.now()+e,renderChatSendButton(),chatCooldownTimer&&clearInterval(chatCooldownTimer),chatCooldownTimer=setInterval((()=>{renderChatSendButton(),Date.now()>=chatCooldownUntil&&(clearInterval(chatCooldownTimer),chatCooldownTimer=null,renderChatSendButton())}),150)}async function sendChat(){const e=(chatInput.value||"").trim();if(!user)return showToast("error","Sign in to chat"),void openModal(authModal);if(!e)return;if(!(Date.now()<chatCooldownUntil)){if(e.length>600)return showToast("error","Message too long (max 600 chars)");chatSending=!0,renderChatSendButton(),startChatCooldown(5e3);try{const t=getUsername();await sbExec((()=>supabase.from("chat_messages").insert({content:e,username:t,user_id:user.id,is_system:!1})),{timeoutMs:1e4,retryAuth:!0}),chatInput.value="",autoResizeChatInput(),renderChatSendButton(),scrollChatToBottom({force:!0,smooth:!0})}catch(e){console.error(e),String(e.message||"").toLowerCase().includes("rate")&&startChatCooldown(5e3),showToast("error",e.message||"Failed to send")}finally{chatSending=!1,renderChatSendButton()}}}function autoResizeChatInput(){chatInput.style.height="auto",chatInput.style.height=Math.min(chatInput.scrollHeight,140)+"px"}function openChatFromClick(){if(!user)return showToast("info","Sign in to join the chat"),void openModal(authModal);openChat()}function openChat(){user&&(openModal(chatModal),updateSelfAvatar(),renderChatSendButton(),loadChatHistory().then((()=>scrollChatToBottom({force:!0,smooth:!1}))),setupChatRealtime(),setupTyping(),updateURL())}function closeChat(){closeModal(chatModal),updateURL()}function maybeOpenChatFromURL(){"1"===new URLSearchParams(window.location.search).get("chat")&&(user&&!chatModal.classList.contains("open")&&openChat(),user||authModal.classList.contains("open")||openModal(authModal))}async function wakeRefresh(e="focus"){if(!user)return;if(!navigator.onLine)return;const t=Date.now();return t-lastWakeRefreshAt<8e3?void 0:(lastWakeRefreshAt=t,wakeRefreshInFlight||(wakeRefreshInFlight=(async()=>{try{await ensureFreshSession({force:!1,reason:"wakeRefresh:"+e}),setupPresence(),setupRealtime(),chatModal.classList.contains("open")&&(setupChatRealtime(),setupTyping()),await loadEntries({showSkeleton:!1,silent:!0,retryIfEmpty:!0});for(const e of entryPending.keys())flushEntryPatch(e)}catch(e){console.warn("wakeRefresh error:",e)}finally{wakeRefreshInFlight=null}})(),wakeRefreshInFlight))}window.addEventListener("scroll",onAnyScroll,{passive:!0}),document.addEventListener("scroll",onAnyScroll,{passive:!0,capture:!0}),["touchstart","mousemove","keydown"].forEach((e=>{window.addEventListener(e,refreshScrollTopVisibilityFromActivity,{passive:!0})})),prefCover&&prefCover.addEventListener("change",(async()=>{try{defaultCoverSource=prefCover.value,await sbExec((()=>supabase.from("profiles").update({cover_source:defaultCoverSource}).eq("id",user.id)),{timeoutMs:9e3,retryAuth:!0}),showToast("success","Cover source set to "+defaultCoverSource),enqueueMissingCovers(data)}catch{showToast("error","Failed to save preference")}})),accountClearList.onclick=()=>{if(!user)return showToast("error","Sign in first");openConfirm("Clear your entire list (1/3)","Recommended: Export JSON first. Continue?",(async()=>{openConfirm("Double-check (2/3)","This will permanently delete ALL items. Proceed?",(async()=>{openConfirm("Last chance (3/3)","No undo. Delete everything now?",(async()=>{showLoading(!0);try{try{await sbExec((()=>supabase.rpc("delete_all_entries")),{timeoutMs:15e3,retryAuth:!0})}catch(e){await sbExec((()=>supabase.from("entries").delete().eq("user_id",user.id)),{timeoutMs:15e3,retryAuth:!0})}data=[],render(),showToast("success","Your list was cleared")}catch(e){console.error(e),showToast("error",e.message||"Failed to clear list")}finally{showLoading(!1)}}))}))}))},accountLogout.onclick=()=>openConfirm("Sign out","Are you sure you want to sign out?",(async()=>{await supabase.auth.signOut(),location.reload()})),accountChangePfp.onclick=async()=>{if(!user)return showToast("error","Sign in first");openModal(pfpModal),renderPfpSkeletons(),await regeneratePfp()},pfpCancel.onclick=()=>closeModal(pfpModal),pfpRegenerate.onclick=()=>regeneratePfp(),pfpConfirm.onclick=async()=>{if(!user)return showToast("error","Sign in first");if(pfpSelectedSeed){pfpConfirm.classList.add("loading"),pfpConfirm.innerHTML="Confirm",pfpConfirm.disabled=!0;try{const e=[...avatarSeedHistory].slice(-120);await sbExec((()=>supabase.from("profiles").update({avatar_seed:pfpSelectedSeed,avatar_seed_history:e}).eq("id",user.id)),{timeoutMs:1e4,retryAuth:!0}),profile||(profile={}),profile.avatar_seed=pfpSelectedSeed,profile.avatar_seed_history=e,updateAccountUI(),updateSelfAvatar(),refreshChatMyAvatars(),showToast("success","Profile pic updated"),closeModal(pfpModal)}catch(e){console.error(e),showToast("error",e.message||"Failed to update avatar")}finally{pfpConfirm.classList.remove("loading"),pfpConfirm.innerHTML='<i class="fa-solid fa-check"></i>Confirm new pfp',setPfpButtonsState()}}},btnAutoCover.addEventListener("click",(async()=>{const e=fTitle.value?.trim();if(!e)return showToast("error","Enter title first");btnAutoCover.classList.add("loading"),btnAutoCover.innerHTML="Auto cover";try{const t=fCoverSource.value||null,n=t||defaultCoverSource,a=!!t,o=await autoFetchCover(e,n,a);o?.image?(fImage.value=o.image,initFloatingLabels(modal),toggleClearButtons(),showToast("success","Cover set")):showToast("error","No cover found")}finally{btnAutoCover.classList.remove("loading"),btnAutoCover.innerHTML='<i class="fa-solid fa-wand-magic-sparkles"></i>Auto cover'}})),btnRefreshCovers.addEventListener("click",(()=>{if(!user)return showToast("error","Sign in first");enqueueMissingCovers(data),showToast("success","Cover refresh started")})),tabSignin.onclick=()=>{tabSignin.classList.add("active"),tabSignup.classList.remove("active"),signinForm.classList.remove("hidden"),signupForm.classList.add("hidden")},tabSignup.onclick=()=>{tabSignup.classList.add("active"),tabSignin.classList.remove("active"),signupForm.classList.remove("hidden"),signinForm.classList.add("hidden")},authClose.onclick=()=>closeModal(authModal),authClose2.onclick=()=>closeModal(authModal),[loginIdentifier,loginPassword].forEach((e=>e.addEventListener("keydown",(e=>{"Enter"===e.key&&loginSend.click()})))),[signupUsername,signupEmail,signupPassword].forEach((e=>e.addEventListener("keydown",(e=>{"Enter"===e.key&&signupSend.click()})))),loginSend.onclick=async()=>{loginSend.classList.add("loading"),loginSend.innerHTML="Sign in";const e=(loginIdentifier.value||"").trim(),t=loginPassword.value;if(!e||!t)return showToast("error","Enter username/email and password"),loginSend.classList.remove("loading"),void(loginSend.innerHTML='<i class="fa-solid fa-right-to-bracket"></i>Sign in');try{const{data:n,error:a}=await supabase.rpc("email_for_username",{p_identifier:e});if(a)throw a;const o=n?.email;if(!o)throw new Error("User not found");const{error:s}=await supabase.auth.signInWithPassword({email:o,password:t});if(s)throw s;showToast("success","Signed in successfully"),closeModal(authModal)}catch(e){console.error(e),showToast("error",e.message||"Sign-in failed")}finally{loginSend.classList.remove("loading"),loginSend.innerHTML='<i class="fa-solid fa-right-to-bracket"></i>Sign in'}},forgotPasswordLink.onclick=async()=>{try{const e=(loginIdentifier.value||"").trim();if(!e)return showToast("error","Enter your username or email first");const{data:t,error:n}=await supabase.rpc("email_for_username",{p_identifier:e});if(n)throw n;const a=t?.email;if(!a)throw new Error("User not found");const{error:o}=await supabase.auth.resetPasswordForEmail(a,{redirectTo:window.location.origin+window.location.pathname});if(o)throw o;showToast("success","Reset email sent")}catch(e){showToast("error",e.message||"Could not send reset email")}},signupSend.onclick=async()=>{signupSend.classList.add("loading"),signupSend.innerHTML="Sign up";const e=(signupUsername.value||"").trim(),t=(signupEmail.value||"").trim(),n=signupPassword.value;if(!e||!t||!n)return showToast("error","All fields are required"),signupSend.classList.remove("loading"),void(signupSend.innerHTML='<i class="fa-solid fa-user-plus"></i>Sign up');if(n.length<6)return showToast("error","Password must be at least 6 characters"),signupSend.classList.remove("loading"),void(signupSend.innerHTML='<i class="fa-solid fa-user-plus"></i>Sign up');try{const{data:a}=await supabase.from("profiles").select("id").eq("username",e).maybeSingle();if(a)throw new Error("Username already taken");const{error:o}=await supabase.auth.signUp({email:t,password:n,options:{data:{username:e}}});if(o)throw o;showToast("success","Account created! Check your email to verify."),closeModal(authModal)}catch(e){console.error(e),showToast("error",e.message||"Sign-up failed")}finally{signupSend.classList.remove("loading"),signupSend.innerHTML='<i class="fa-solid fa-user-plus"></i>Sign up'}},resendConfirmationLink.onclick=async()=>{try{const e=(signupEmail.value||"").trim();if(!e)return showToast("error","Enter your email first");const{error:t}=await supabase.auth.resend({type:"signup",email:e});if(t)throw t;showToast("success","Confirmation email resent")}catch(e){showToast("error",e.message||"Failed to resend")}},verifyReload.onclick=()=>location.reload(),window.addEventListener("offline",syncOfflineModal),window.addEventListener("online",(async()=>{syncOfflineModal(),showToast("success","Back online");for(const e of entryPending.keys())flushEntryPatch(e);await wakeRefresh("online")})),chatInput.addEventListener("input",(()=>{autoResizeChatInput(),broadcastTypingDebounced(),renderChatSendButton()})),chatInput.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),sendChat())})),chatSend.addEventListener("click",sendChat),chatClose.addEventListener("click",(()=>closeChat())),chatBottomFab.addEventListener("click",(()=>scrollChatToBottom({force:!0,smooth:!0}))),chatMessagesEl.addEventListener("scroll",(()=>{chatMessagesEl.scrollHeight-chatMessagesEl.scrollTop-chatMessagesEl.clientHeight>120?chatBottomFab.classList.add("visible"):chatBottomFab.classList.remove("visible")}),{passive:!0}),checkEmailVerifyLanding(),syncOfflineModal(),document.addEventListener("visibilitychange",(()=>{if("hidden"===document.visibilityState&&(lastHiddenAt=Date.now()),"visible"===document.visibilityState){(lastHiddenAt?Date.now()-lastHiddenAt:0)>1200&&wakeRefresh("visibility")}})),window.addEventListener("focus",(()=>wakeRefresh("focus"))),window.addEventListener("pageshow",(e=>{e.persisted&&wakeRefresh("pageshow")}));let authListenerStarted=!1;async function handleSessionChange(e,t="unknown"){session=e,user=e?.user??null,updateAuthUI(),setupPresence(),updateMobileMenuUI(),user?(await loadProfile(),updateAuthUI(),updateMobileMenuUI(),renderTabs(),updateViewToggleUI(),updateSortToggleUI(),initFloatingLabels(document),await loadEntries({showSkeleton:0===data.length,silent:!1,retryIfEmpty:!0}),setupRealtime(),render(),maybeOpenChatFromURL()):(data=[],render(),chatModal.classList.contains("open")&&closeChat())}function startAuthListener(){authListenerStarted||(authListenerStarted=!0,supabase.auth.onAuthStateChange((async(e,t)=>{try{await handleSessionChange(t,e)}catch(e){console.error("Auth change handler error:",e)}})))}async function initApp(){showPreloader("Loading AniMehList…"),setRandomBanner(),readURL(),renderTabs(),updateViewToggleUI(),updateSortToggleUI(),initFloatingLabels(document);try{startAuthListener(),await withTimeout(supabase.auth.getSession(),2500,"Session warmup timed out").catch((()=>null));const e=(await supabase.auth.getSession().catch((()=>null)))?.data?.session??null;e?await handleSessionChange(e,"startup"):render(),maybeOpenChatFromURL()}catch(e){console.error("Init error:",e),showToast("error",e.message||"App failed to start"),render()}finally{hidePreloader()}}initApp()</script></html>
